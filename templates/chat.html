{% extends "base.html" %} {% block title %}{{ chat.name }} - HangSpace{%
endblock %} {% block extra_css %}
<link
  href="{{ url_for('static', filename='css/chat.css') }}"
  rel="stylesheet"
/>
{% endblock %} {% block content %}
<div class="chat-container" id="chatContainer" data-chat-id="{{ chat._id }}">
  <!-- Chat Header -->
  <div class="chat-header" id="chatHeader">
    <div style="display: flex; align-items: center">
      <a href="{{ url_for('dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div class="chat-info" id="chatInfo" style="cursor: pointer">
        {% if chat.other_user_avatar %}
        <img
          src="{{ chat.other_user_avatar }}"
          alt="{{ chat.name }}"
          class="chat-avatar-img"
        />
        {% else %}
        <div class="chat-avatar">{{ chat.name[0]|upper }}</div>
        {% endif %}
        <div class="chat-details" onclick="openUserProfile(event)">
          <h2 id="chatTitle">{{ chat.name }}</h2>
          <p id="participantsInfo">
            {% if chat.is_group %} {{ chat.participants|length }} participants
            {% else %} {% set other_user_id =
            chat.participants|reject("equalto", user._id)|first %}
            <span
              id="userStatus"
              data-user-id="{{ other_user_id }}"
              class="status-indicator"
            >
              <span class="status-dot"></span>
              <span class="status-text">
                {% if chat.other_user_status %} {{ chat.other_user_status|title
                }} {% else %} Checking... {% endif %}
              </span>
            </span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    <div class="chat-actions">
      <!-- Theme Menu Button -->
      <div class="dropdown">
        <button class="btn dropdown-toggle" id="themeMenuButton">
          <i class="fas fa-palette"></i>
        </button>
        <div class="dropdown-menu" id="themeMenu">
          <div class="dropdown-header">
            <i class="fas fa-palette"></i> Chat Themes
          </div>
          <div class="theme-options">
            <div
              class="theme-option"
              data-theme="default"
              onclick="applyTheme('default')"
            >
              <div class="theme-preview default-theme"></div>
              <span>Default</span>
            </div>
            <div
              class="theme-option"
              data-theme="romantic"
              onclick="applyTheme('romantic')"
            >
              <div class="theme-preview romantic-theme"></div>
              <span>Romantic</span>
            </div>
            <div
              class="theme-option"
              data-theme="dark"
              onclick="applyTheme('dark')"
            >
              <div class="theme-preview dark-theme"></div>
              <span>Dark</span>
            </div>
            <div
              class="theme-option"
              data-theme="nature"
              onclick="applyTheme('nature')"
            >
              <div class="theme-preview nature-theme"></div>
              <span>Nature</span>
            </div>
            <div
              class="theme-option"
              data-theme="ocean"
              onclick="applyTheme('ocean')"
            >
              <div class="theme-preview ocean-theme"></div>
              <span>Ocean</span>
            </div>
            <div
              class="theme-option"
              data-theme="sunset"
              onclick="applyTheme('sunset')"
            >
              <div class="theme-preview sunset-theme"></div>
              <span>Sunset</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" onclick="resetTheme()">
            <i class="fas fa-undo"></i> Reset to Default
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" id="messagesContainer">
    {% for message in messages %}
    <div
      class="message-wrapper {% if message.sender_id == user._id %}own-message{% else %}other-message{% endif %}"
    >
      <div
        class="message {% if message.sender_id == user._id %}own{% else %}other{% endif %}"
        data-message-id="{{ message._id }}"
        data-sender-id="{{ message.sender_id }}"
      >
        <div class="message-bubble">
          {% if message.sender_id != user._id %}
          <div class="message-sender" id="sender-{{ message.sender_id }}">
            {{ get_sender_name(message.sender_id) }}
          </div>
          {% endif %}

          <div class="message-content" id="content-{{ message._id }}">
            {% if message.is_deleted %}
            <em style="color: #999; font-style: italic"
              >This message was deleted</em
            >
            {% elif message.type == 'file' and message.file_metadata %}
            <!-- File message content will be handled by JavaScript -->
            <div id="file-message-{{ message._id }}"></div>
            {% else %} {{ message.content }} {% if message.is_edited %}
            <span class="status-indicator edited">edited</span>
            {% endif %} {% endif %}
          </div>

          <!-- File Message Handling -->
          {% if message.type == 'file' and message.file_metadata %}
          <div
            class="file-message"
            data-file-id="{{ message.file_metadata._id }}"
            data-file-type="{{ message.file_metadata.file_type }}"
          >
            <div
              class="file-preview"
              onclick="previewFile('{{ message.file_metadata._id }}')"
            >
              {% if message.file_metadata.file_type == 'image' %}
              <img
                src="{{ message.file_metadata.thumbnail_url or message.file_metadata.url }}"
                alt="{{ message.file_metadata.original_filename }}"
                class="file-thumbnail image"
              />
              {% elif message.file_metadata.file_type == 'video' %}
              <div class="file-thumbnail video">
                <i class="fas fa-play-circle"></i>
                <img
                  src="{{ message.file_metadata.thumbnail_url or url_for('static', filename='images/video-thumbnail.png') }}"
                  alt="{{ message.file_metadata.original_filename }}"
                />
              </div>
              {% elif message.file_metadata.file_type == 'audio' %}
              <div class="file-thumbnail audio">
                <i class="fas fa-music"></i>
              </div>
              {% else %}
              <div class="file-thumbnail document">
                <i class="fas fa-file"></i>
              </div>
              {% endif %}
            </div>
            <div class="file-info">
              <div class="file-name">
                {{ message.file_metadata.original_filename }}
              </div>
              <div class="file-size">
                {{ (message.file_metadata.file_size / 1024 / 1024) | round(2) }}
                MB
              </div>
              <div class="file-actions">
                <button
                  class="btn-icon"
                  onclick="downloadFile('{{ message.file_metadata._id }}')"
                  title="Download"
                >
                  <i class="fas fa-download"></i>
                </button>
                <button
                  class="btn-icon"
                  onclick="forwardFile('{{ message.file_metadata._id }}')"
                  title="Forward"
                >
                  <i class="fas fa-share"></i>
                </button>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Message Reactions -->
          <div class="message-reactions" id="reactions-{{ message._id }}">
            {% if message.reactions %} {% for reaction in message.reactions %}
            <span class="reaction" data-emoji="{{ reaction.emoji }}">
              {{ reaction.emoji }}
              <span class="reaction-count">{{ reaction.count }}</span>
            </span>
            {% endfor %} {% endif %}
          </div>

          <div class="message-time" id="time-{{ message._id }}">
            {{ message.timestamp.strftime('%I:%M %p') }} {% if message.is_edited
            %}
            <span style="color: #666; font-size: 0.8em">‚Ä¢ edited</span>
            {% endif %}
          </div>

          {% if message.sender_id == user._id and not message.is_deleted %}
          <div class="read-receipt" id="read-receipt-{{ message._id }}">
            {% if message.read_by and message.read_by|length > 1 %}
            <i class="fas fa-check-double" style="color: #4caf50"></i>
            <span style="font-size: 0.8em; color: #666">Seen</span>
            {% else %}
            <i class="fas fa-check" style="color: #666"></i>
            <span style="font-size: 0.8em; color: #666">Sent</span>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Message Actions -->
        {% if message.sender_id == user._id and not message.is_deleted %}
        <div class="message-actions" id="actions-{{ message._id }}">
          <button
            class="message-action-btn edit"
            onclick="editMessage('{{ message._id }}')"
            title="Edit message"
          >
            <i class="fas fa-edit"></i>
          </button>
          <button
            class="message-action-btn history"
            onclick="showMessageHistory('{{ message._id }}')"
            title="View history"
          >
            <i class="fas fa-history"></i>
          </button>
          <button
            class="message-action-btn delete"
            onclick="showDeleteOptions('{{ message._id }}')"
            title="Delete message"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>
        {% endif %}
      </div>

      <!-- Message Menu -->
      {% if message.sender_id == user._id and not message.is_deleted %}
      <div class="message-menu" id="messageMenu-{{ message._id }}">
        <div class="menu-content">
          <button
            class="menu-item edit"
            onclick="editMessage('{{ message._id }}')"
          >
            <i class="fas fa-edit"></i> Edit Message
          </button>
          <button
            class="menu-item history"
            onclick="showMessageHistory('{{ message._id }}')"
          >
            <i class="fas fa-history"></i> View History
          </button>
          <div class="menu-divider"></div>
          <button
            class="menu-item delete"
            onclick="showDeleteOptions('{{ message._id }}')"
          >
            <i class="fas fa-trash"></i> Delete Message
          </button>
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Typing Indicator -->
  <div class="typing-indicator" id="typingIndicator" style="display: none">
    <span id="typingText"></span> is typing...
  </div>

  <!-- Message Input -->
  <div class="message-input-container" id="messageInputContainer">
    <div class="message-input-wrapper">
      <!-- File upload button -->
      <button class="file-upload-btn" id="fileUploadBtn" title="Attach file">
        <i class="fas fa-paperclip"></i>
      </button>

      <input
        type="file"
        id="fileInput"
        style="display: none"
        multiple
        accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx"
      />

      <!-- Emoji picker button -->
      <button class="emoji-picker-btn" id="emojiPickerBtn" title="Add emoji">
        <i class="fas fa-smile"></i>
      </button>

      <textarea
        class="message-input"
        id="messageInput"
        placeholder="Type a message..."
        rows="1"
        onkeydown="handleKeyDown(event)"
        oninput="handleInput()"
      ></textarea>

      <button class="send-button" id="sendButton" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<!-- File preview modal -->
<div class="custom-modal" id="filePreviewModal">
  <div class="modal-content large">
    <div class="modal-header">
      <h3>File Preview</h3>
      <button class="close-modal" onclick="closeFilePreview()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="filePreviewContent">
      <!-- File preview will be loaded here -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="downloadCurrentFile()">
        <i class="fas fa-download"></i> Download
      </button>
      <button class="btn btn-primary" onclick="forwardCurrentFile()">
        <i class="fas fa-share"></i> Forward
      </button>
    </div>
  </div>
</div>

<!-- Forward file modal -->
<div class="custom-modal" id="forwardFileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Forward File</h3>
      <button class="close-modal" onclick="closeForwardModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="forward-file-info" id="forwardFileInfo">
        <!-- File info will be loaded here -->
      </div>
      <div class="form-group">
        <label for="forwardMessage">Add a message (optional):</label>
        <textarea
          id="forwardMessage"
          placeholder="Add a message..."
          rows="3"
        ></textarea>
      </div>
      <div class="friends-list">
        <h4>Select friends to forward to:</h4>
        <div id="forwardFriendsList" class="friends-checkbox-list">
          <!-- Friends list will be loaded here -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeForwardModal()">
        Cancel
      </button>
      <button class="btn btn-primary" onclick="sendForward()">Forward</button>
    </div>
  </div>
</div>

<!-- Emoji picker modal -->
<div class="custom-modal" id="emojiPickerModal">
  <div class="modal-content emoji-picker">
    <div class="modal-header">
      <h3>Choose an Emoji</h3>
      <button class="close-modal" onclick="closeEmojiPicker()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div
      class="modal-body"
      style="padding: 0; display: flex; flex-direction: column; height: 100%"
    >
      <div
        class="emoji-categories"
        style="
          display: flex;
          border-bottom: 1px solid #e0e0e0;
          padding: 0 16px;
          background: #f8f9fa;
        "
      >
        <button
          class="emoji-category active"
          data-category="recent"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          Recent
        </button>
        <button
          class="emoji-category"
          data-category="smileys"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          üòä
        </button>
        <button
          class="emoji-category"
          data-category="hearts"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          ‚ù§Ô∏è
        </button>
        <button
          class="emoji-category"
          data-category="thumbs"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          üëç
        </button>
        <button
          class="emoji-category"
          data-category="objects"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          üì±
        </button>
        <button
          class="emoji-category"
          data-category="symbols"
          style="
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
          "
        >
          ‚≠ê
        </button>
      </div>
      <div
        class="emoji-grid"
        id="emojiGrid"
        style="
          display: grid;
          grid-template-columns: repeat(8, 1fr);
          gap: 8px;
          padding: 16px;
          max-height: 300px;
          overflow-y: auto;
          flex: 1;
        "
      >
        <!-- Emojis will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Delete Options Modal -->
<div class="custom-modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Delete Message</h3>
      <button class="close-modal" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>How would you like to delete this message?</p>
      <div class="delete-options">
        <button class="delete-option" onclick="deleteForMe()">
          <div class="option-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="option-content">
            <strong>Delete for me</strong>
            <span>Remove this message from your view only</span>
          </div>
        </button>

        <button class="delete-option" onclick="deleteForEveryone()">
          <div class="option-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="option-content">
            <strong>Delete for everyone</strong>
            <span>Remove this message for all participants</span>
          </div>
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Message History Modal -->
<div class="history-modal" id="historyModal">
  <div class="history-content">
    <div class="history-header">
      <h3>Message History</h3>
      <button class="close-history" onclick="closeHistoryModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="historyContent"></div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
    // ==================== GLOBAL VARIABLES ====================
  const chatId = "{{ chat._id }}";
  const currentUserId = "{{ user._id }}";
  let isTyping = false;
  let typingTimer;
  let socket = null;
  let messageIds = new Set();
  let currentTheme = "default";

  // Message management variables
  let editingMessageId = null;
  let messageMenuOpen = null;

  // Delete functionality variables
  let currentDeleteMessageId = null;

  // File handling variables
  let currentPreviewFileId = null;
  let currentForwardFileId = null;
  let currentReactionMessageId = null;

  // Mobile long-press variables
  let longPressTimer;
  let longPressTarget;

  // Store participant statuses
  let participantStatuses = new Map();

  // Store chat data for profile navigation
  const chatData = {
      id: "{{ chat._id }}",
      isGroup: {{ chat.is_group|tojson }},
      participants: {{ chat.participants|tojson }},
      name: "{{ chat.name }}"
  };

  // ==================== THEME CONFIGURATION ====================
  const themes = {
      default: {
          background: "var(--bg-primary)",
          headerBg: "var(--bg-secondary)",
          ownBubble: "var(--primary)",
          otherBubble: "var(--bg-secondary)",
          textColor: "var(--text-dark)",
          inputBg: "var(--bg-secondary)",
          iconColor: "var(--text-dark)",
          messageContainerBg: "transparent",
          headerTextColor: "var(--text-dark)",
          inputTextColor: "var(--text-dark)",
          timeTextColor: "var(--text-light)",
          senderTextColor: "var(--primary)",
      },
      romantic: {
          background: "linear-gradient(135deg, #ffafbd, #ffc3a0)",
          headerBg: "rgba(255, 182, 193, 0.95)",
          ownBubble: "#ff6b95",
          otherBubble: "rgba(255, 255, 255, 0.95)",
          textColor: "#8b4513",
          inputBg: "rgba(255, 255, 255, 0.9)",
          iconColor: "#8b4513",
          messageContainerBg: "rgba(255, 255, 255, 0.1)",
          headerTextColor: "#8b4513",
          inputTextColor: "#8b4513",
          timeTextColor: "rgba(139, 69, 19, 0.7)",
          senderTextColor: "#ff6b95",
      },
      dark: {
          background: "linear-gradient(135deg, #2c3e50, #34495e)",
          headerBg: "rgba(44, 62, 80, 0.95)",
          ownBubble: "#3498db",
          otherBubble: "rgba(52, 73, 94, 0.9)",
          textColor: "#ecf0f1",
          inputBg: "rgba(52, 73, 94, 0.8)",
          iconColor: "#ecf0f1",
          messageContainerBg: "rgba(0, 0, 0, 0.2)",
          headerTextColor: "#ecf0f1",
          inputTextColor: "#ecf0f1",
          timeTextColor: "rgba(236, 240, 241, 0.7)",
          senderTextColor: "#3498db",
      },
      nature: {
          background: "linear-gradient(135deg, #667eea, #764ba2)",
          headerBg: "rgba(102, 126, 234, 0.95)",
          ownBubble: "#48bb78",
          otherBubble: "rgba(226, 232, 240, 0.95)",
          textColor: "#2d3748",
          inputBg: "rgba(226, 232, 240, 0.9)",
          iconColor: "#2d3748",
          messageContainerBg: "rgba(255, 255, 255, 0.1)",
          headerTextColor: "#2d3748",
          inputTextColor: "#2d3748",
          timeTextColor: "rgba(45, 55, 72, 0.7)",
          senderTextColor: "#48bb78",
      },
      ocean: {
          background: "linear-gradient(135deg, #4facfe, #00f2fe)",
          headerBg: "rgba(79, 172, 254, 0.95)",
          ownBubble: "#3182ce",
          otherBubble: "rgba(255, 255, 255, 0.95)",
          textColor: "#2c5282",
          inputBg: "rgba(255, 255, 255, 0.9)",
          iconColor: "#2c5282",
          messageContainerBg: "rgba(255, 255, 255, 0.1)",
          headerTextColor: "#2c5282",
          inputTextColor: "#2c5282",
          timeTextColor: "rgba(44, 82, 130, 0.7)",
          senderTextColor: "#3182ce",
      },
      sunset: {
          background: "linear-gradient(135deg, #fa709a, #fee140)",
          headerBg: "rgba(250, 112, 154, 0.95)",
          ownBubble: "#e53e3e",
          otherBubble: "rgba(255, 255, 255, 0.95)",
          textColor: "#744210",
          inputBg: "rgba(255, 255, 255, 0.9)",
          iconColor: "#744210",
          messageContainerBg: "rgba(255, 255, 255, 0.1)",
          headerTextColor: "#744210",
          inputTextColor: "#744210",
          timeTextColor: "rgba(116, 66, 16, 0.7)",
          senderTextColor: "#e53e3e",
      },
  };

  // ==================== THEME ANIMATION FUNCTIONS ====================

  function createThemeAnimations(themeName) {
      removeAllThemeAnimations();

      switch(themeName) {
          case 'romantic':
              createFloatingHearts();
              createRomanticSparkles();
              break;
          case 'dark':
              createDarkModeParticles();
              break;
          case 'nature':
              createFloatingLeaves();
              break;
          case 'ocean':
              createOceanWaves();
              break;
          case 'sunset':
              createSunsetParticles();
              break;
          default:
              createDefaultAnimations();
      }
  }

  function createFloatingHearts() {
      const chatContainer = document.getElementById("chatContainer");
      const existingHearts = document.querySelector(".romantic-hearts");

      if (existingHearts) {
          existingHearts.remove();
      }

      const heartsContainer = document.createElement("div");
      heartsContainer.className = "romantic-hearts";
      chatContainer.appendChild(heartsContainer);

      const heartCount = 15;
      for (let i = 0; i < heartCount; i++) {
          createHeart(heartsContainer, i);
      }

      console.log("üíñ Created floating hearts for romantic theme");
  }

  function createHeart(container, index) {
      const heart = document.createElement("div");
      heart.className = "romantic-heart";

      const sizes = ["small", "medium", "large"];
      const animations = ["floatHeart", "pulse", "sparkle"];

      heart.classList.add(sizes[Math.floor(Math.random() * sizes.length)]);
      heart.style.left = Math.random() * 100 + "%";
      heart.style.top = Math.random() * 100 + "%";
      heart.style.animationDelay = Math.random() * 5 + "s";
      heart.style.animationName = animations[Math.floor(Math.random() * animations.length)];
      heart.style.opacity = Math.random() * 0.5 + 0.3;

      container.appendChild(heart);
  }

  function createRomanticSparkles() {
      const container = document.getElementById('chatContainer');
      const sparklesContainer = document.createElement('div');
      sparklesContainer.className = 'theme-sparkles romantic-sparkles';
      container.appendChild(sparklesContainer);

      for (let i = 0; i < 20; i++) {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          sparkle.style.animationDelay = Math.random() * 3 + 's';
          sparkle.style.animationDuration = (2 + Math.random() * 2) + 's';
          sparklesContainer.appendChild(sparkle);
      }
  }

  function createDarkModeParticles() {
      const container = document.getElementById('chatContainer');
      const particlesContainer = document.createElement('div');
      particlesContainer.className = 'theme-particles dark-particles';
      container.appendChild(particlesContainer);

      for (let i = 0; i < 15; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.top = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 4 + 's';
          particle.style.animationDuration = (3 + Math.random() * 3) + 's';
          particlesContainer.appendChild(particle);
      }
  }

  function createFloatingLeaves() {
      const container = document.getElementById('chatContainer');
      const leavesContainer = document.createElement('div');
      leavesContainer.className = 'theme-leaves nature-leaves';
      container.appendChild(leavesContainer);

      const leafTypes = ['leaf1', 'leaf2', 'leaf3'];

      for (let i = 0; i < 12; i++) {
          const leaf = document.createElement('div');
          leaf.className = `leaf ${leafTypes[Math.floor(Math.random() * leafTypes.length)]}`;
          leaf.style.left = Math.random() * 100 + '%';
          leaf.style.animationDelay = Math.random() * 5 + 's';
          leaf.style.animationDuration = (8 + Math.random() * 4) + 's';
          leavesContainer.appendChild(leaf);
      }
  }

  function createOceanWaves() {
      const container = document.getElementById('chatContainer');
      const wavesContainer = document.createElement('div');
      wavesContainer.className = 'theme-waves ocean-waves';
      container.appendChild(wavesContainer);

      for (let i = 0; i < 3; i++) {
          const wave = document.createElement('div');
          wave.className = `wave wave-${i + 1}`;
          wavesContainer.appendChild(wave);
      }
  }

  function createSunsetParticles() {
      const container = document.getElementById('chatContainer');
      const sunsetContainer = document.createElement('div');
      sunsetContainer.className = 'theme-sunset-particles';
      container.appendChild(sunsetContainer);

      for (let i = 0; i < 25; i++) {
          const particle = document.createElement('div');
          particle.className = 'sunset-particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.top = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 2 + 's';
          particle.style.animationDuration = (2 + Math.random() * 2) + 's';
          sunsetContainer.appendChild(particle);
      }
  }

  function createDefaultAnimations() {
      const container = document.getElementById('chatContainer');
      const defaultAnimContainer = document.createElement('div');
      defaultAnimContainer.className = 'theme-default-animations';
      container.appendChild(defaultAnimContainer);

      for (let i = 0; i < 10; i++) {
          const dot = document.createElement('div');
          dot.className = 'floating-dot';
          dot.style.left = Math.random() * 100 + '%';
          dot.style.top = Math.random() * 100 + '%';
          dot.style.animationDelay = Math.random() * 3 + 's';
          dot.style.animationDuration = (4 + Math.random() * 3) + 's';
          defaultAnimContainer.appendChild(dot);
      }
  }

  function removeAllThemeAnimations() {
      const animations = document.querySelectorAll('.theme-sparkles, .theme-particles, .theme-leaves, .theme-waves, .theme-sunset-particles, .theme-default-animations, .romantic-hearts');
      animations.forEach(anim => anim.remove());
  }

  function removeFloatingHearts() {
      const existingHearts = document.querySelector(".romantic-hearts");
      if (existingHearts) {
          existingHearts.remove();
          console.log("üíñ Removed floating hearts");
      }
  }

  // ==================== MESSAGE SEND ANIMATIONS ====================

  function createSendHeartAnimation() {
      const sendButton = document.getElementById("sendButton");
      const heart = document.createElement("div");
      heart.className = "send-heart";
      heart.innerHTML = "‚ù§Ô∏è";
      heart.style.position = "fixed";
      heart.style.zIndex = "1000";
      heart.style.pointerEvents = "none";

      const rect = sendButton.getBoundingClientRect();
      heart.style.left = rect.left + rect.width / 2 + "px";
      heart.style.top = rect.top + rect.height / 2 + "px";

      document.body.appendChild(heart);

      setTimeout(() => {
          heart.remove();
      }, 2000);
  }

  function animateMessageSend(messageElement, theme) {
      switch(theme) {
          case 'romantic':
              // Add heart particles around the message
              for (let i = 0; i < 3; i++) {
                  setTimeout(() => {
                      createHeartParticle(messageElement);
                  }, i * 100);
              }
              break;
          case 'dark':
              // Add subtle glow effect
              messageElement.style.boxShadow = '0 0 20px rgba(52, 152, 219, 0.3)';
              setTimeout(() => {
                  messageElement.style.boxShadow = 'none';
              }, 1000);
              break;
          case 'nature':
              // Add leaf floating effect
              createLeafParticle(messageElement);
              break;
          case 'ocean':
              // Add water ripple effect
              createRippleEffect(messageElement);
              break;
          case 'sunset':
              // Add sunset glow effect
              messageElement.style.background = 'linear-gradient(45deg, #fa709a, #fee140)';
              setTimeout(() => {
                  messageElement.style.background = '';
              }, 500);
              break;
      }
  }

  function createHeartParticle(messageElement) {
      const heart = document.createElement('div');
      heart.className = 'romantic-heart';
      heart.innerHTML = '‚ù§Ô∏è';
      heart.style.cssText = `
          position: absolute;
          font-size: 16px;
          pointer-events: none;
          z-index: 10;
          animation: floatHeart 1.5s ease-out forwards;
      `;

      const rect = messageElement.getBoundingClientRect();
      heart.style.left = rect.left + Math.random() * rect.width + 'px';
      heart.style.top = rect.top + 'px';

      document.body.appendChild(heart);

      setTimeout(() => {
          heart.remove();
      }, 1500);
  }

  function createLeafParticle(messageElement) {
      const leaf = document.createElement('div');
      leaf.className = 'leaf';
      leaf.innerHTML = 'üçÉ';
      leaf.style.cssText = `
          position: absolute;
          font-size: 18px;
          pointer-events: none;
          z-index: 10;
          animation: floatLeaf 2s ease-out forwards;
      `;

      const rect = messageElement.getBoundingClientRect();
      leaf.style.left = rect.left + Math.random() * rect.width + 'px';
      leaf.style.top = rect.top + 'px';

      document.body.appendChild(leaf);

      setTimeout(() => {
          leaf.remove();
      }, 2000);
  }

  function createRippleEffect(messageElement) {
      const ripple = document.createElement('div');
      ripple.className = 'ripple';
      ripple.style.cssText = `
          position: absolute;
          width: 100px;
          height: 100px;
          border: 2px solid rgba(79, 172, 254, 0.5);
          border-radius: 50%;
          pointer-events: none;
          z-index: 10;
          animation: rippleExpand 1s ease-out forwards;
      `;

      const rect = messageElement.getBoundingClientRect();
      ripple.style.left = rect.left + rect.width / 2 - 50 + 'px';
      ripple.style.top = rect.top + rect.height / 2 - 50 + 'px';

      document.body.appendChild(ripple);

      setTimeout(() => {
          ripple.remove();
      }, 1000);
  }

  function animateMessageReaction(messageId, emoji) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageElement) return;

      const reaction = document.createElement('div');
      reaction.className = 'reaction-pop';
      reaction.textContent = emoji;
      reaction.style.cssText = `
          position: absolute;
          font-size: 24px;
          pointer-events: none;
          z-index: 100;
          animation: reactionPop 0.6s ease-out forwards;
      `;

      const rect = messageElement.getBoundingClientRect();
      reaction.style.left = rect.left + rect.width / 2 + 'px';
      reaction.style.top = rect.top + 'px';

      document.body.appendChild(reaction);

      setTimeout(() => {
          reaction.remove();
      }, 600);
  }

  function createThemeTransition() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.style.transition = 'all 0.5s ease';

      // Add a subtle pulse effect during theme change
      chatContainer.style.animation = 'pulse 0.5s ease';
      setTimeout(() => {
          chatContainer.style.animation = '';
      }, 500);
  }

  // ==================== THEME MANAGEMENT FUNCTIONS ====================

  async function applyTheme(themeName) {
      const theme = themes[themeName];
      if (!theme) {
          console.error("‚ùå Theme not found:", themeName);
          showNotification('Theme not found', 'error');
          return;
      }

      // Create transition effect
      createThemeTransition();

      currentTheme = themeName;
      removeAllThemeAnimations();
      applyThemeToElements(theme);
      createThemeAnimations(themeName);

      try {
          console.log(`üé® Saving theme ${themeName} for chat ${chatId}`);

          const response = await fetch("/api/save-chat-theme", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                  chat_id: chatId,
                  theme_name: themeName,
              }),
          });

          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
              const text = await response.text();
              console.error("‚ùå Server returned non-JSON response:", text.substring(0, 100));
              throw new Error('Server error: Invalid response format');
          }

          const result = await response.json();

          if (result.success) {
              console.log(`‚úÖ Theme '${themeName}' saved for all participants`);
              showNotification(`Theme applied for both users`, 'success');
          } else {
              console.error("‚ùå Failed to save theme:", result.error);
              showNotification('Failed to apply theme: ' + (result.error || 'Unknown error'), 'error');
          }
      } catch (error) {
          console.error("‚ùå Error saving theme:", error);
          showNotification('Error applying theme: ' + error.message, 'error');
      }

      closeThemeMenu();
  }

  function applyThemeSilently(themeName) {
      const theme = themes[themeName];
      if (!theme) {
          console.error("‚ùå Theme not found:", themeName);
          return;
      }

      currentTheme = themeName;
      removeAllThemeAnimations();
      applyThemeToElements(theme);
      createThemeAnimations(themeName);

      console.log(`üé® Theme synchronized to: ${themeName}`);
      showNotification(`Theme changed to ${themeName}`, 'info');
  }

  async function resetTheme() {
      try {
          // Create transition effect
          createThemeTransition();

          const defaultTheme = themes["default"];
          if (defaultTheme) {
              currentTheme = "default";
              removeAllThemeAnimations();
              applyThemeToElements(defaultTheme);
              createThemeAnimations('default');
          }

          console.log(`üé® Resetting theme for chat ${chatId}`);

          const response = await fetch("/api/reset-chat-theme", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                  chat_id: chatId,
              }),
          });

          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
              const text = await response.text();
              console.error("‚ùå Server returned non-JSON response:", text.substring(0, 100));
              throw new Error('Server error: Invalid response format');
          }

          const result = await response.json();
          if (result.success) {
              console.log("‚úÖ Theme reset for all participants");
              showNotification('Theme reset for both users', 'success');
          } else {
              console.error("‚ùå Failed to reset theme:", result.error);
              showNotification('Failed to reset theme: ' + (result.error || 'Unknown error'), 'error');
          }
      } catch (error) {
          console.error("‚ùå Error resetting theme:", error);
          showNotification('Error resetting theme: ' + error.message, 'error');
      }

      closeThemeMenu();
  }

  async function loadThemePreference() {
      try {
          console.log(`üé® Loading theme preference for chat ${chatId}`);

          const response = await fetch("/api/get-chat-theme", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                  chat_id: chatId,
              }),
          });

          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
              console.warn("‚ö†Ô∏è Could not load theme preference: Server returned non-JSON response");
              return;
          }

          const result = await response.json();
          if (result.success && result.theme_name && result.theme_name !== "default") {
              console.log(`üé® Loading saved theme: ${result.theme_name}`);
              applyThemeSilently(result.theme_name);
          }
      } catch (error) {
          console.error("‚ùå Error loading theme preference:", error);
      }
  }

  function applyThemeToElements(theme) {
      try {
          const chatContainer = document.getElementById("chatContainer");
          const chatHeader = document.getElementById("chatHeader");
          const messagesContainer = document.getElementById("messagesContainer");
          const messageInputContainer = document.getElementById("messageInputContainer");
          const messageInput = document.getElementById("messageInput");
          const chatTitle = document.getElementById("chatTitle");
          const chatAvatar = document.querySelector(".chat-avatar");

          if (chatContainer) chatContainer.style.background = theme.background;
          if (chatContainer) chatContainer.style.color = theme.textColor;

          if (chatHeader) chatHeader.style.background = theme.headerBg;
          if (chatHeader) chatHeader.style.color = theme.headerTextColor;

          if (messagesContainer) messagesContainer.style.background = theme.messageContainerBg;

          if (messageInputContainer) messageInputContainer.style.background = theme.inputBg;

          if (messageInput) {
              messageInput.style.background = "transparent";
              messageInput.style.color = theme.inputTextColor;
              messageInput.style.borderColor = theme.iconColor;
          }

          if (chatTitle) chatTitle.style.color = theme.headerTextColor;
          if (chatAvatar) chatAvatar.style.color = theme.headerTextColor;

          updateAllMessageBubbles(theme);

          const themeButton = document.getElementById("themeMenuButton");
          if (themeButton) {
              themeButton.style.color = theme.iconColor;
              themeButton.style.background = theme.inputBg;
          }

          const backButton = document.querySelector(".back-button");
          if (backButton) backButton.style.color = theme.iconColor;

          const sendButton = document.getElementById("sendButton");
          if (sendButton) {
              sendButton.style.color = theme.iconColor;
              sendButton.style.background = theme.ownBubble;
          }

          const emojiButton = document.getElementById("emojiPickerBtn");
          const fileButton = document.getElementById("fileUploadBtn");
          if (emojiButton) emojiButton.style.color = theme.iconColor;
          if (fileButton) fileButton.style.color = theme.iconColor;
      } catch (error) {
          console.error("‚ùå Error applying theme to elements:", error);
      }
  }

  function updateAllMessageBubbles(theme) {
      try {
          document.querySelectorAll(".message.own .message-bubble").forEach((bubble) => {
              bubble.style.background = theme.ownBubble;
              bubble.style.color = "white";
          });

          document.querySelectorAll(".message.other .message-bubble").forEach((bubble) => {
              bubble.style.background = theme.otherBubble;
              bubble.style.color = theme.textColor;
          });

          document.querySelectorAll(".message-time").forEach((time) => {
              time.style.color = theme.timeTextColor;
          });

          document.querySelectorAll(".message-sender").forEach((sender) => {
              sender.style.color = theme.senderTextColor;
          });
      } catch (error) {
          console.error("‚ùå Error updating message bubbles:", error);
      }
  }

  function updateNewMessageBubble(messageElement, theme) {
      try {
          const isOwnMessage = messageElement.classList.contains("own");
          const bubble = messageElement.querySelector(".message-bubble");
          const time = messageElement.querySelector(".message-time");
          const sender = messageElement.querySelector(".message-sender");

          if (bubble) {
              if (isOwnMessage) {
                  bubble.style.background = theme.ownBubble;
                  bubble.style.color = "white";
              } else {
                  bubble.style.background = theme.otherBubble;
                  bubble.style.color = theme.textColor;
              }
          }

          if (time) {
              time.style.color = theme.timeTextColor;
          }

          if (sender) {
              sender.style.color = theme.senderTextColor;
          }
      } catch (error) {
          console.error("‚ùå Error updating new message bubble:", error);
      }
  }

  function toggleThemeMenu() {
      const menu = document.getElementById("themeMenu");
      if (menu) {
          menu.style.display = menu.style.display === "block" ? "none" : "block";
      }
  }

  function closeThemeMenu() {
      const menu = document.getElementById("themeMenu");
      if (menu) {
          menu.style.display = "none";
      }
  }

  // ==================== MESSAGE PERSISTENCE FUNCTIONS ====================
  function storeMessageLocally(messageData) {
      try {
          const key = `chat_${chatId}_messages`;
          let messages = JSON.parse(localStorage.getItem(key)) || [];

          // Remove existing message with same ID
          messages = messages.filter(msg => msg.message_id !== messageData.message_id);

          // Add new message
          messages.push(messageData);

          // Keep only last 100 messages to prevent storage overflow
          if (messages.length > 100) {
              messages = messages.slice(-100);
          }

          localStorage.setItem(key, JSON.stringify(messages));
      } catch (e) {
          console.error("Error storing message locally:", e);
      }
  }

  function loadLocalMessages() {
      try {
          const key = `chat_${chatId}_messages`;
          const messages = JSON.parse(localStorage.getItem(key)) || [];

          messages.forEach(messageData => {
              if (!messageIds.has(messageData.message_id)) {
                  messageIds.add(messageData.message_id);
                  addMessageToChat(messageData);
              }
          });

          scrollToBottom();
      } catch (e) {
          console.error("Error loading local messages:", e);
      }
  }

  function clearLocalMessages() {
      try {
          const key = `chat_${chatId}_messages`;
          localStorage.removeItem(key);
      } catch (e) {
          console.error("Error clearing local messages:", e);
      }
  }

  // ==================== SOCKET.IO FUNCTIONS ====================
  function initializeSocket() {
      if (socket) {
          socket.disconnect();
      }

      socket = io();

      socket.on("connect", function () {
          console.log("Connected to server");
          socket.emit("join_chat", { chat_id: chatId });
          socket.emit("request_initial_statuses", { chat_id: chatId });
      });

      socket.on("new_message", function (data) {
          console.log("Received new message:", data.message_id);

          if (!messageIds.has(data.message_id)) {
              messageIds.add(data.message_id);
              addMessageToChat(data);
              scrollToBottom();
              storeMessageLocally(data); // Store for persistence

              if (data.sender_id !== currentUserId) {
                  markMessageAsRead(data.message_id);
              }
          } else {
              console.log("Duplicate message ignored:", data.message_id);
          }
      });

      socket.on("user_typing", function (data) {
          showTypingIndicator(data);
      });

      socket.on("user_online", function (data) {
          console.log(`üü¢ User ${data.user_id} is online`);
          updateUserStatus(data.user_id, "online");
      });

      socket.on("user_offline", function (data) {
          console.log(`üî¥ User ${data.user_id} is offline`);
          updateUserStatus(data.user_id, "offline");
      });

      socket.on("initial_statuses", function (data) {
          console.log("Received initial statuses:", data.statuses);
          data.statuses.forEach(status => {
              updateUserStatus(status.user_id, status.status);
          });
      });

      socket.on("message_updated", function (data) {
          console.log("Message updated:", data.message_id);
          handleMessageUpdated(data);
      });

      socket.on("message_deleted", function (data) {
          console.log("Message deleted:", data.message_id);
          handleMessageDeleted(data);
      });

      socket.on("message_read_receipt", function (data) {
          console.log("Message read receipt:", data.message_id, "by", data.reader_id);
          updateMessageReadStatus(data.message_id, data.reader_id, data.read_at);
      });

      socket.on("message_deleted_for_user", function (data) {
          console.log("Message deleted for user:", data.message_id, "user:", data.user_id);
          if (data.user_id === currentUserId && data.message_id) {
              removeMessageFromUI(data.message_id);
          }
      });

      socket.on("message_deleted_for_everyone", function (data) {
          console.log("Message deleted for everyone:", data.message_id);
          if (data.message_id) {
              const contentElement = document.getElementById(`content-${data.message_id}`);
              const actionsElement = document.getElementById(`actions-${data.message_id}`);
              const menuElement = document.getElementById(`messageMenu-${data.message_id}`);

              if (contentElement) {
                  contentElement.innerHTML = '<em style="color: #999; font-style: italic;">This message was deleted</em>';
              }

              if (actionsElement) {
                  actionsElement.remove();
              }

              if (menuElement) {
                  menuElement.remove();
              }

              const readReceipt = document.getElementById(`read-receipt-${data.message_id}`);
              if (readReceipt) {
                  readReceipt.style.display = 'none';
              }
          }
      });

      socket.on("reaction_updated", function(data) {
          handleReactionUpdate(data);
      });

      socket.on("theme_updated", function(data) {
          console.log(`üé® Theme updated to: ${data.theme_name} by user: ${data.updated_by}`);

          if (data.updated_by !== currentUserId) {
              applyThemeSilently(data.theme_name);
          }
      });

      socket.on("disconnect", function () {
          console.log("Socket disconnected");
      });
  }

  // ==================== MESSAGE ACTIONS FUNCTIONS ====================
  function setupMessageActions() {
      const messagesContainer = document.getElementById('messagesContainer');

      if (!messagesContainer) {
          console.error('‚ùå Messages container not found');
          return;
      }

      // Desktop: hover events
      messagesContainer.addEventListener('mouseenter', function(e) {
          const messageElement = e.target.closest('.message[data-message-id]');
          if (messageElement && messageElement.classList.contains('own')) {
              const messageId = messageElement.getAttribute('data-message-id');
              const messageContent = document.getElementById(`content-${messageId}`);

              if (messageContent && !messageContent.innerHTML.includes('This message was deleted')) {
                  showMessageActions(messageId);
              }
          }
      }, true);

      messagesContainer.addEventListener('mouseleave', function(e) {
          const messageElement = e.target.closest('.message[data-message-id]');
          if (messageElement && messageElement.classList.contains('own')) {
              const messageId = messageElement.getAttribute('data-message-id');
              if (messageMenuOpen !== messageId) {
                  hideMessageActions(messageId);
              }
          }
      }, true);

      // Mobile: touch events
      setupMobileMessageActions();

      // Desktop: right-click context menu
      setupDesktopRightClick();

      console.log('‚úÖ Message actions initialized');
  }

  function setupMobileMessageActions() {
      const messagesContainer = document.getElementById('messagesContainer');

      messagesContainer.addEventListener('touchstart', function(e) {
          const messageElement = e.target.closest('.message[data-message-id]');
          if (messageElement && messageElement.classList.contains('own')) {
              const messageId = messageElement.getAttribute('data-message-id');
              const messageContent = document.getElementById(`content-${messageId}`);

              if (messageContent && !messageContent.innerHTML.includes('This message was deleted')) {
                  showMessageActions(messageId);

                  longPressTarget = messageElement;
                  longPressTimer = setTimeout(() => {
                      openMessageMenu(messageId, e);
                      e.preventDefault();
                  }, 500);
              }
          }
      });

      messagesContainer.addEventListener('touchend', function(e) {
          clearTimeout(longPressTimer);
      });

      messagesContainer.addEventListener('touchmove', function(e) {
          clearTimeout(longPressTimer);
      });
  }

  function setupDesktopRightClick() {
      const messagesContainer = document.getElementById('messagesContainer');

      messagesContainer.addEventListener('contextmenu', function(e) {
          const messageElement = e.target.closest('.message[data-message-id]');
          if (messageElement && messageElement.classList.contains('own')) {
              const messageId = messageElement.getAttribute('data-message-id');
              const messageContent = document.getElementById(`content-${messageId}`);

              if (messageContent && !messageContent.innerHTML.includes('This message was deleted')) {
                  openMessageMenu(messageId, e);
                  e.preventDefault();
                  return false;
              }
          }
      });
  }

  function showMessageActions(messageId) {
      const actions = document.getElementById(`actions-${messageId}`);
      if (actions) {
          actions.style.opacity = '1';
          actions.style.visibility = 'visible';
      }
  }

  function hideMessageActions(messageId) {
      const actions = document.getElementById(`actions-${messageId}`);
      if (actions && messageMenuOpen !== messageId) {
          actions.style.opacity = '0';
          actions.style.visibility = 'hidden';
      }
  }

  function openMessageMenu(messageId, event) {
      if (event) {
          event.preventDefault();
          event.stopPropagation();
      }

      closeMessageMenu();
      messageMenuOpen = messageId;

      const menu = document.getElementById(`messageMenu-${messageId}`);
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);

      if (menu && messageElement) {
          const rect = messageElement.getBoundingClientRect();
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

          menu.style.display = 'block';
          menu.style.visibility = 'visible';
          menu.style.opacity = '1';
          menu.style.position = 'absolute';

          if (window.innerWidth > 768) {
              menu.style.left = `${rect.left + scrollLeft - menu.offsetWidth - 10}px`;
          } else {
              menu.style.left = `${rect.left + scrollLeft}px`;
              menu.style.top = `${rect.bottom + scrollTop + 5}px`;
          }

          menu.style.zIndex = '1000';
          showMessageActions(messageId);
      }
  }

  function closeMessageMenu() {
      if (messageMenuOpen) {
          const menu = document.getElementById(`messageMenu-${messageMenuOpen}`);
          if (menu) {
              menu.style.display = 'none';
              menu.style.visibility = 'hidden';
              menu.style.opacity = '0';
          }
          hideMessageActions(messageMenuOpen);
          messageMenuOpen = null;
      }
  }

  // ==================== FILE HANDLING FUNCTIONS ====================
  function initializeFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const fileUploadBtn = document.getElementById('fileUploadBtn');

      if (fileUploadBtn && fileInput) {
          fileUploadBtn.addEventListener('click', function() {
              fileInput.click();
          });

          fileInput.addEventListener('change', function(e) {
              if (e.target.files.length > 0) {
                  uploadFiles(e.target.files);
              }
          });
      }

      // Add drag and drop support
      const messageInputContainer = document.getElementById('messageInputContainer');
      if (messageInputContainer) {
          messageInputContainer.addEventListener('dragover', function(e) {
              e.preventDefault();
              messageInputContainer.classList.add('drag-over');
          });

          messageInputContainer.addEventListener('dragleave', function(e) {
              e.preventDefault();
              messageInputContainer.classList.remove('drag-over');
          });

          messageInputContainer.addEventListener('drop', function(e) {
              e.preventDefault();
              messageInputContainer.classList.remove('drag-over');

              if (e.dataTransfer.files.length > 0) {
                  uploadFiles(e.dataTransfer.files);
              }
          });
      }

      console.log('‚úÖ File upload initialized');
  }

  async function uploadFiles(files) {
      for (let file of files) {
          await uploadFile(file);
      }
  }

  async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('chat_id', chatId);

      try {
          showNotification(`Uploading ${file.name}...`, 'info');

          const response = await fetch('/api/upload-file', {
              method: 'POST',
              body: formData
          });

          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Upload failed: ${response.status} ${response.statusText} - ${errorText}`);
          }

          const result = await response.json();

          if (result.success) {
              showNotification(`File "${file.name}" uploaded successfully`, 'success');
              console.log('‚úÖ File upload successful:', result);
          } else {
              console.error('Upload failed:', result.error);
              showNotification(`Failed to upload "${file.name}": ${result.error}`, 'error');
          }
      } catch (error) {
          console.error('Error uploading file:', error);
          showNotification(`Error uploading "${file.name}": ${error.message}`, 'error');
      }
  }

  function previewFile(fileId) {
      console.log('Previewing file:', fileId);

      const fileMessage = document.querySelector(`[data-file-id="${fileId}"]`);
      if (!fileMessage) {
          console.error('File message not found:', fileId);
          showNotification('File not found', 'error');
          return;
      }

      const fileType = fileMessage.dataset.fileType;
      const modal = document.getElementById('filePreviewModal');
      const content = document.getElementById('filePreviewContent');

      if (!modal || !content) {
          console.error('Preview modal elements not found');
          showNotification('Preview not available', 'error');
          return;
      }

      let previewHTML = '';

      const fileNameElement = fileMessage.querySelector('.file-name');
      const fileName = fileNameElement ? fileNameElement.textContent : 'File';

      const imgElement = fileMessage.querySelector('img');
      const imgSrc = imgElement ? imgElement.src : null;

      switch (fileType) {
          case 'image':
              if (imgSrc) {
                  previewHTML = `
              <div style="text-align: center; padding: 20px;">
                <img src="${imgSrc}"
                     style="max-width: 100%; max-height: 60vh; border-radius: 8px; object-fit: contain;"
                     alt="${fileName}"
                     onerror="handlePreviewError()">
                <div style="margin-top: 16px; font-size: 14px; color: #666;">${fileName}</div>
              </div>
            `;
              } else {
                  previewHTML = `
              <div style="text-align: center; padding: 40px;">
                <i class="fas fa-image" style="font-size: 64px; color: #666; margin-bottom: 16px;"></i>
                <p>Image preview not available</p>
                <div style="margin-bottom: 16px; color: #666;">${fileName}</div>
                <button class="btn btn-primary" onclick="downloadFileFromMessage('${fileId}')">
                  <i class="fas fa-download"></i> Download File
                </button>
              </div>
            `;
              }
              break;
          case 'video':
              previewHTML = `
            <div style="text-align: center; padding: 40px;">
              <i class="fas fa-video" style="font-size: 64px; color: #666; margin-bottom: 16px;"></i>
              <p>Video preview not available in browser</p>
              <div style="margin-bottom: 16px; color: #666;">${fileName}</div>
              <button class="btn btn-primary" onclick="downloadFileFromMessage('${fileId}')">
                <i class="fas fa-download"></i> Download Video
              </button>
            </div>
          `;
              break;
          case 'audio':
              previewHTML = `
            <div style="text-align: center; padding: 40px;">
              <i class="fas fa-music" style="font-size: 64px; color: #666; margin-bottom: 16px;"></i>
              <p>Audio preview not available</p>
              <div style="margin-bottom: 16px; color: #666;">${fileName}</div>
              <button class="btn btn-primary" onclick="downloadFileFromMessage('${fileId}')">
                <i class="fas fa-download"></i> Download Audio
              </button>
            </div>
          `;
              break;
          default:
              previewHTML = `
            <div style="text-align: center; padding: 40px;">
              <i class="fas fa-file" style="font-size: 64px; color: #666; margin-bottom: 16px;"></i>
              <p>This file type cannot be previewed in the browser.</p>
              <div style="margin-bottom: 16px; color: #666;">${fileName}</div>
              <button class="btn btn-primary" onclick="downloadFileFromMessage('${fileId}')">
                <i class="fas fa-download"></i> Download File
              </button>
            </div>
          `;
      }

      content.innerHTML = previewHTML;
      modal.style.display = 'block';
      currentPreviewFileId = fileId;

      console.log('Preview modal opened for file:', fileId);
  }

  function handlePreviewError() {
      const content = document.getElementById('filePreviewContent');
      content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #f59e0b; margin-bottom: 16px;"></i>
          <p>Failed to load preview</p>
          <button class="btn btn-primary" onclick="downloadFileFromMessage('${currentPreviewFileId}')">
            <i class="fas fa-download"></i> Download File
          </button>
        </div>
      `;
  }

  function closeFilePreview() {
      const modal = document.getElementById('filePreviewModal');
      if (modal) {
          modal.style.display = 'none';
      }
      currentPreviewFileId = null;
  }

  async function downloadFileFromMessage(messageId) {
      console.log('Downloading file from message:', messageId);

      try {
          // First get the file message data
          const messageResponse = await fetch(`/api/get-file-message/${messageId}`);

          if (!messageResponse.ok) {
              throw new Error(`HTTP error! status: ${messageResponse.status}`);
          }

          const messageResult = await messageResponse.json();

          if (messageResult.success && messageResult.message && messageResult.message.type === 'file' && messageResult.message.file_metadata) {
              const fileMeta = messageResult.message.file_metadata;

              // Construct download URL
              const downloadUrl = `/api/download-file/${fileMeta.uploaded_by || messageResult.message.sender_id}/${fileMeta.saved_filename}`;

              console.log('Download URL:', downloadUrl);

              // Create a temporary link to trigger download
              const link = document.createElement('a');
              link.href = downloadUrl;
              link.download = fileMeta.original_filename || 'download';
              link.target = '_blank';

              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              showNotification(`Downloading ${fileMeta.original_filename}...`, 'success');
          } else {
              throw new Error('File metadata not found');
          }
      } catch (error) {
          console.error('Error downloading file:', error);
          showNotification('Error downloading file. Please try again.', 'error');

          // Fallback: try direct download endpoint
          try {
              const fallbackUrl = `/api/download-file/${messageId}`;
              const link = document.createElement('a');
              link.href = fallbackUrl;
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          } catch (fallbackError) {
              console.error('Fallback download also failed:', fallbackError);
          }
      }
  }

  function downloadCurrentFile() {
      if (currentPreviewFileId) {
          downloadFileFromMessage(currentPreviewFileId);
      }
  }

  function forwardCurrentFile() {
      if (currentPreviewFileId) {
          forwardFile(currentPreviewFileId);
          closeFilePreview();
      }
  }

  async function forwardFile(fileId) {
      try {
          console.log('Forwarding file:', fileId);

          // First, get the file message data
          const messageResponse = await fetch(`/api/get-file-message/${fileId}`);

          if (!messageResponse.ok) {
              throw new Error(`Failed to get file data: ${messageResponse.status}`);
          }

          const messageResult = await messageResponse.json();

          if (!messageResult.success || !messageResult.message || messageResult.message.type !== 'file') {
              throw new Error('File message not found or not a file');
          }

          // Get friends list
          let friendsList = [];

          try {
              const friendsResponse = await fetch('/api/friends');

              if (friendsResponse.ok) {
                  const friendsResult = await friendsResponse.json();
                  console.log('Friends API response:', friendsResult);

                  if (friendsResult.friends && Array.isArray(friendsResult.friends)) {
                      friendsList = friendsResult.friends;
                  } else if (friendsResult.users && Array.isArray(friendsResult.users)) {
                      friendsList = friendsResult.users;
                  } else if (Array.isArray(friendsResult)) {
                      friendsList = friendsResult;
                  }
              }
          } catch (friendsError) {
              console.warn('Primary friends endpoint failed:', friendsError);
          }

          if (friendsList.length > 0) {
              showForwardModal(fileId, friendsList, messageResult.message.file_metadata);
          } else {
              showNotification('No friends found to forward to. Please add friends first.', 'info');
          }
      } catch (error) {
          console.error('Error in forwardFile:', error);
          showNotification('Error: ' + error.message, 'error');
      }
  }

  function showForwardModal(fileId, friends, fileMetadata) {
      const modal = document.getElementById('forwardFileModal');
      const fileInfo = document.getElementById('forwardFileInfo');
      const friendsList = document.getElementById('forwardFriendsList');

      if (!modal || !fileInfo || !friendsList) {
          console.error('Forward modal elements not found');
          showNotification('Forward feature not available', 'error');
          return;
      }

      modal.dataset.fileMetadata = JSON.stringify(fileMetadata);

      fileInfo.innerHTML = `
        <div class="file-info-preview">
          <i class="fas fa-file" style="font-size: 24px; color: #666; margin-right: 12px;"></i>
          <div>
            <strong>${fileMetadata.original_filename}</strong>
            <div style="font-size: 12px; color: #666;">${(fileMetadata.file_size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ Ready to forward</div>
          </div>
        </div>
      `;

      friendsList.innerHTML = friends.map(friend => `
        <div class="friend-checkbox-item">
          <label>
            <input type="checkbox" value="${friend._id}" class="friend-checkbox">
            <div class="friend-avatar">${friend.display_name?.[0]?.toUpperCase() || friend.username[0].toUpperCase()}</div>
            <div class="friend-info">
              <div class="friend-name">${friend.display_name || friend.username}</div>
              <div class="friend-status">${friend.status || 'offline'}</div>
            </div>
          </label>
        </div>
      `).join('');

      modal.style.display = 'block';
      currentForwardFileId = fileId;
  }

  function closeForwardModal() {
      const modal = document.getElementById('forwardFileModal');
      if (modal) {
          modal.style.display = 'none';
      }
      currentForwardFileId = null;
  }

  async function sendForward() {
      if (!currentForwardFileId) return;

      const modal = document.getElementById('forwardFileModal');
      const fileMetadata = JSON.parse(modal.dataset.fileMetadata || '{}');
      const selectedFriends = Array.from(document.querySelectorAll('.friend-checkbox:checked'))
          .map(checkbox => checkbox.value);

      const message = document.getElementById('forwardMessage').value;

      if (selectedFriends.length === 0) {
          showNotification('Please select at least one friend', 'error');
          return;
      }

      if (!fileMetadata.saved_filename) {
          showNotification('File data is missing. Cannot forward.', 'error');
          return;
      }

      try {
          const response = await fetch('/api/forward-file', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  file_id: currentForwardFileId,
                  file_metadata: fileMetadata,
                  friend_ids: selectedFriends,
                  message: message
              }),
          });

          const result = await response.json();

          if (result.success) {
              const successCount = result.results.filter(r => r.success).length;
              showNotification(`File forwarded to ${successCount} friends`, 'success');
              closeForwardModal();
          } else {
              showNotification(`Forward failed: ${result.error}`, 'error');
          }
      } catch (error) {
          console.error('Error forwarding file:', error);
          showNotification('Error forwarding file', 'error');
      }
  }

  // ==================== EMOJI PICKER FUNCTIONS ====================
  function initializeEmojiPickerButton() {
      const emojiPickerBtn = document.getElementById('emojiPickerBtn');
      const emojiPickerModal = document.getElementById('emojiPickerModal');

      if (emojiPickerBtn && emojiPickerModal) {
          emojiPickerBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();

              const messageInputContainer = document.getElementById('messageInputContainer');
              const containerRect = messageInputContainer.getBoundingClientRect();

              emojiPickerModal.style.display = 'block';
              emojiPickerModal.style.position = 'fixed';
              emojiPickerModal.style.left = '50%';
              emojiPickerModal.style.top = `${Math.max(containerRect.top - 350, 10)}px`;
              emojiPickerModal.style.transform = 'translateX(-50%)';
              emojiPickerModal.style.zIndex = '10000';
              emojiPickerModal.style.width = '75%';
              emojiPickerModal.style.maxWidth = '500px';
              emojiPickerModal.style.height = '400px';
              emojiPickerModal.style.background = 'white';
              emojiPickerModal.style.borderRadius = '12px';
              emojiPickerModal.style.boxShadow = '0 10px 40px rgba(0,0,0,0.2)';
              emojiPickerModal.style.overflow = 'hidden';

              if (!window.emojiPickerInitialized) {
                  initializeEmojiPicker();
                  window.emojiPickerInitialized = true;
              }
          });
      }
  }

  function initializeEmojiPicker() {
      const emojiCategories = {
          smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†'],
          hearts: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü'],
          thumbs: ['üëç', 'üëé', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§ô', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ'],
          objects: ['üîî', 'üíé', 'üíç', 'üì±', 'üíª', 'üì∑', 'üéÆ', 'üé∏', 'üé®', '‚öΩ', 'üèÄ', 'üéæ', 'üèÜ', 'üé≠', 'üé¨', 'üéµ', 'üé∂', 'üéπ', 'ü•Å', 'üé§', 'üéß', 'üéº', 'üé∫', 'üéª', 'üé∑'],
          symbols: ['‚≠ê', 'üåü', '‚ú®', 'üí´', 'üî•', 'üí•', '‚ö°', 'üåà', '‚òÄÔ∏è', 'üåô', 'üíß', 'üåä', 'üçÄ', 'üåπ', 'üå∏', 'üå∫', 'üåª', 'üåº']
      };

      const emojiGrid = document.getElementById('emojiGrid');
      let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');

      function renderEmojis(category) {
          let emojis = [];

          if (category === 'recent') {
              emojis = recentEmojis.length > 0 ? recentEmojis : emojiCategories.smileys.slice(0, 12);
          } else {
              emojis = emojiCategories[category] || [];
          }

          emojiGrid.innerHTML = emojis.map(emoji => `
              <span class="emoji-option" onclick="selectEmojiForInput('${emoji}')">${emoji}</span>
          `).join('');
      }

      renderEmojis('recent');

      document.querySelectorAll('.emoji-category').forEach(button => {
          button.addEventListener('click', function() {
              document.querySelectorAll('.emoji-category').forEach(btn => btn.classList.remove('active'));
              this.classList.add('active');
              renderEmojis(this.dataset.category);
          });
      });

      console.log('‚úÖ Emoji picker initialized');
  }

  function selectEmojiForInput(emoji) {
      console.log('Selected emoji for input:', emoji);

      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
          const startPos = messageInput.selectionStart;
          const endPos = messageInput.selectionEnd;
          const currentValue = messageInput.value;

          messageInput.value = currentValue.substring(0, startPos) + emoji + currentValue.substring(endPos);

          messageInput.selectionStart = messageInput.selectionEnd = startPos + emoji.length;

          messageInput.focus();

          messageInput.dispatchEvent(new Event('input'));
      }

      let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');
      recentEmojis = recentEmojis.filter(e => e !== emoji);
      recentEmojis.unshift(emoji);
      recentEmojis = recentEmojis.slice(0, 12);
      localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));

      closeEmojiPicker();
  }

  function closeEmojiPicker() {
      const modal = document.getElementById('emojiPickerModal');
      if (modal) {
          modal.style.display = 'none';
      }
      currentReactionMessageId = null;
  }

  // ==================== EMOJI REACTION FUNCTIONS ====================
  function initializeEmojiReactions() {
      const messagesContainer = document.getElementById('messagesContainer');

      messagesContainer.addEventListener('dblclick', function(e) {
          const messageElement = e.target.closest('.message[data-message-id]');
          if (messageElement && !messageElement.classList.contains('own')) {
              const messageId = messageElement.getAttribute('data-message-id');
              showEmojiPicker(messageId, e.clientX, e.clientY);
          }
      });

      let lastTap = 0;
      messagesContainer.addEventListener('touchstart', function(e) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;

          if (tapLength < 500 && tapLength > 0) {
              const messageElement = e.target.closest('.message[data-message-id]');
              if (messageElement && !messageElement.classList.contains('own')) {
                  const messageId = messageElement.getAttribute('data-message-id');
                  const touch = e.touches[0];
                  showEmojiPicker(messageId, touch.clientX, touch.clientY);
                  e.preventDefault();
              }
          }

          lastTap = currentTime;
      });
  }

  function showEmojiPicker(messageId, x, y) {
      currentReactionMessageId = messageId;

      const modal = document.getElementById('emojiPickerModal');

      const messageInputContainer = document.getElementById('messageInputContainer');
      const containerRect = messageInputContainer.getBoundingClientRect();

      modal.style.display = 'block';
      modal.style.position = 'fixed';
      modal.style.left = '50%';
      modal.style.top = `${containerRect.top - 320}px`;
      modal.style.transform = 'translateX(-50%)';
      modal.style.zIndex = '10000';
      modal.style.width = '75%';
      modal.style.maxWidth = '500px';
      modal.style.height = '400px';

      const modalRect = modal.getBoundingClientRect();
      if (modalRect.top < 10) {
          modal.style.top = '10px';
      }
  }

  function handleReactionUpdate(data) {
      const reactionsContainer = document.getElementById(`reactions-${data.message_id}`);
      if (!reactionsContainer) return;

      reactionsContainer.innerHTML = '';

      if (data.reactions && data.reactions.length > 0) {
          data.reactions.forEach(reaction => {
              const reactionElement = document.createElement('span');
              reactionElement.className = 'reaction';
              reactionElement.dataset.emoji = reaction.emoji;
              reactionElement.innerHTML = `${reaction.emoji} <span class="reaction-count">${reaction.count}</span>`;

              reactionElement.addEventListener('click', function() {
                  removeReaction(data.message_id, reaction.emoji);
              });

              reactionsContainer.appendChild(reactionElement);
          });
      }
  }

  async function removeReaction(messageId, emoji) {
      try {
          const response = await fetch('/api/remove-reaction', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  message_id: messageId,
                  emoji: emoji
              }),
          });
      } catch (error) {
          console.error('Error removing reaction:', error);
      }
  }

  // ==================== DELETE FUNCTIONS ====================
  function showDeleteOptions(messageId) {
      console.log('Showing delete options for message:', messageId);
      currentDeleteMessageId = messageId;
      const modal = document.getElementById('deleteModal');
      if (modal) {
          modal.style.display = 'block';
          modal.style.visibility = 'visible';
          modal.style.opacity = '1';
      }
      closeMessageMenu();
  }

  function closeDeleteModal() {
      const modal = document.getElementById('deleteModal');
      if (modal) {
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
      }
      currentDeleteMessageId = null;
  }

  async function deleteForMe() {
      if (!currentDeleteMessageId) return;

      try {
          const response = await fetch('/api/delete-message-for-user', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  message_id: currentDeleteMessageId
              }),
          });

          const result = await response.json();
          if (result.success) {
              showNotification('Message deleted for you', 'success');
              removeMessageFromUI(currentDeleteMessageId);
          } else {
              showNotification(result.error || 'Failed to delete message', 'error');
          }
      } catch (error) {
          console.error('Error deleting message for me:', error);
          showNotification('Error deleting message', 'error');
      }

      closeDeleteModal();
  }

  async function deleteForEveryone() {
      if (!currentDeleteMessageId) return;

      try {
          const response = await fetch('/api/delete-message-for-everyone', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  message_id: currentDeleteMessageId
              }),
          });

          const result = await response.json();
          if (result.success) {
              showNotification('Message deleted for everyone', 'success');
          } else {
              showNotification(result.error || 'Failed to delete message', 'error');
          }
      } catch (error) {
          console.error('Error deleting message for everyone:', error);
          showNotification('Error deleting message', 'error');
      }

      closeDeleteModal();
  }

  function removeMessageFromUI(messageId) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement) {
          messageElement.style.opacity = '0.5';
          messageElement.style.transition = 'opacity 0.3s ease';

          setTimeout(() => {
              messageElement.remove();

              const menuElement = document.getElementById(`messageMenu-${messageId}`);
              if (menuElement) {
                  menuElement.remove();
              }
          }, 300);
      }
  }

  // ==================== MESSAGE MANAGEMENT FUNCTIONS ====================
  function editMessage(messageId) {
      console.log('Editing message:', messageId);

      if (editingMessageId) {
          cancelEdit(editingMessageId);
      }

      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      const contentElement = document.getElementById(`content-${messageId}`);

      if (!contentElement) {
          console.error('Content element not found for message:', messageId);
          showNotification('Error: Could not edit message', 'error');
          return;
      }

      let originalContent = contentElement.textContent;
      originalContent = originalContent.replace(/\(edited\)/g, '')
          .replace('edited', '')
          .trim();

      contentElement.innerHTML = `
          <div class="edit-message-container">
              <textarea class="edit-message-input" maxlength="1000" placeholder="Edit your message...">${originalContent}</textarea>
              <div class="edit-message-actions">
                  <div class="edit-character-count" id="charCount-${messageId}">
                      ${originalContent.length}/1000 characters
                  </div>
                  <button class="btn-sm btn-secondary" onclick="cancelEdit('${messageId}')">
                      <i class="fas fa-times"></i> Cancel
                  </button>
                  <button class="btn-sm btn-primary" onclick="saveMessageEdit('${messageId}')">
                      <i class="fas fa-check"></i> Save
                  </button>
              </div>
          </div>
      `;

      editingMessageId = messageId;
      closeMessageMenu();

      const textarea = contentElement.querySelector('.edit-message-input');
      const charCount = document.getElementById(`charCount-${messageId}`);

      if (textarea) {
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);

          textarea.addEventListener('input', function() {
              const length = this.value.length;
              charCount.textContent = `${length}/1000 characters`;

              if (length > 900) {
                  charCount.classList.add('warning');
                  charCount.classList.remove('error');
              } else if (length > 1000) {
                  charCount.classList.add('error');
                  charCount.classList.remove('warning');
              } else {
                  charCount.classList.remove('warning', 'error');
              }
          });

          textarea.style.height = 'auto';
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      }
  }

  function cancelEdit(messageId) {
      const contentElement = document.getElementById(`content-${messageId}`);
      if (!contentElement) return;

      const textarea = contentElement.querySelector('.edit-message-input');
      const currentContent = textarea ? textarea.value : '';

      contentElement.textContent = currentContent;

      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement && messageElement.querySelector('.status-indicator.edited')) {
          const editedSpan = document.createElement('span');
          editedSpan.className = 'status-indicator edited';
          editedSpan.textContent = 'edited';
          contentElement.appendChild(editedSpan);
      }

      editingMessageId = null;
  }

  async function saveMessageEdit(messageId) {
      const contentElement = document.getElementById(`content-${messageId}`);
      if (!contentElement) return;

      const textarea = contentElement.querySelector('.edit-message-input');
      if (!textarea) return;

      const newContent = textarea.value.trim();

      if (!newContent) {
          showNotification('Message cannot be empty', 'error');
          return;
      }

      if (newContent.length > 1000) {
          showNotification('Message is too long (max 1000 characters)', 'error');
          return;
      }

      try {
          const response = await fetch('/api/update-message', {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                  message_id: messageId,
                  new_content: newContent
              }),
          });

          const result = await response.json();
          if (result.success) {
              showNotification('Message updated successfully', 'success');
              editingMessageId = null;
          } else {
              showNotification(result.error || 'Failed to update message', 'error');
              cancelEdit(messageId);
          }
      } catch (error) {
          console.error('Error updating message:', error);
          showNotification('Error updating message', 'error');
          cancelEdit(messageId);
      }
  }

  async function showMessageHistory(messageId) {
      console.log('Showing history for message:', messageId);

      try {
          const response = await fetch(`/api/get-message-history/${messageId}`);

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
              showHistoryModal(result.history, messageId);
          } else {
              console.error('API returned error:', result.error);
              showNotification('Could not load message history: ' + (result.error || 'Unknown error'), 'error');
          }
      } catch (error) {
          console.error('Error loading message history:', error);
          showNotification('Error loading message history. Please try again.', 'error');
      }

      closeMessageMenu();
  }

  function showHistoryModal(history, messageId) {
      const modal = document.getElementById('historyModal');
      const historyContent = document.getElementById('historyContent');

      if (!modal || !historyContent) {
          console.error('History modal elements not found');
          return;
      }

      let historyHTML = `
        <div class="history-item original">
          <strong>Original Message:</strong>
          <div class="history-content-text">${escapeHtml(history.original_content)}</div>
          <div class="history-meta">
            <span>First sent</span>
          </div>
        </div>
      `;

      if (history.edits && history.edits.length > 0) {
          history.edits.forEach(edit => {
              historyHTML += `
            <div class="history-item edit">
              <strong>Edit #${edit.edit_number}:</strong>
              <div class="history-content-text">${escapeHtml(edit.new_content)}</div>
              <div class="history-meta">
                <span>Edited at ${formatTime(new Date(edit.edited_at))}</span>
              </div>
            </div>
          `;
          });
      } else {
          historyHTML += `
          <div class="history-item current">
            <strong>Current Message:</strong>
            <div class="history-content-text">${escapeHtml(history.current_content)}</div>
            <div class="history-meta">
              <span>No edits made</span>
            </div>
          </div>
        `;
      }

      historyHTML += `
        <div class="history-meta" style="margin-top: 16px; text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px;">
          <span>Edited ${history.edit_count} time${history.edit_count !== 1 ? 's' : ''}</span>
        </div>
      `;

      historyContent.innerHTML = historyHTML;
      modal.style.display = 'block';
  }

  function closeHistoryModal() {
      const modal = document.getElementById('historyModal');
      if (modal) {
          modal.style.display = 'none';
      }
  }

  function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
  }

  // ==================== PROFILE NAVIGATION FUNCTIONS ====================
  function openUserProfile(event) {
      console.log('openUserProfile called');

      if (event) {
          event.stopPropagation();
          event.preventDefault();
      }

      if (chatData.isGroup) {
          showGroupInfo();
      } else {
          const otherUserId = getOtherUserId();
          if (otherUserId) {
              console.log(`Navigating to user profile: ${otherUserId}`);
              window.location.href = `/user/${otherUserId}`;
          } else {
              console.error('Could not find other user ID');
              showNotification('Could not find user profile', 'error');
          }
      }
  }

  function getOtherUserId() {
      for (let participantId of chatData.participants) {
          if (participantId !== currentUserId) {
              return participantId;
          }
      }
      return null;
  }

  function showGroupInfo() {
      console.log("Showing group info for:", chatData.name);
      alert(`Group: ${chatData.name}\nParticipants: ${chatData.participants.length} users`);
  }

  // ==================== STATUS MANAGEMENT FUNCTIONS ====================
  async function initializeParticipantStatuses() {
      try {
          await setInitialStatusFromServer();

          const response = await fetch('/api/get-chat-participant-statuses', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  chat_id: chatId,
              }),
          });

          const result = await response.json();
          if (result.success) {
              result.statuses.forEach(status => {
                  participantStatuses.set(status.user_id, status.status);
                  updateUserStatusDisplay(status.user_id, status.status);
              });
              console.log('‚úÖ Participant statuses initialized:', participantStatuses);
          }
      } catch (error) {
          console.error('‚ùå Error initializing participant statuses:', error);
          setFallbackStatus();
      }
  }

  async function setInitialStatusFromServer() {
      const statusElement = document.getElementById('userStatus');
      if (statusElement) {
          const userId = statusElement.getAttribute('data-user-id');
          const statusText = statusElement.querySelector('.status-text');

          try {
              const response = await fetch('/api/get-user-status', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      user_id: userId,
                  }),
              });

              const result = await response.json();
              if (result.success) {
                  updateUserStatus(userId, result.status);
                  console.log(`‚úÖ Set initial status for ${userId}: ${result.status}`);
              } else {
                  throw new Error('API response not successful');
              }
          } catch (error) {
              console.error('‚ùå Error getting initial status:', error);
              const currentStatus = statusText.textContent.trim().toLowerCase();
              if (currentStatus && currentStatus !== 'checking...') {
                  updateUserStatus(userId, currentStatus);
              } else {
                  updateUserStatus(userId, 'offline');
              }
          }
      }
  }

  function setFallbackStatus() {
      const statusElement = document.getElementById('userStatus');
      if (statusElement) {
          const userId = statusElement.getAttribute('data-user-id');
          const statusText = statusElement.querySelector('.status-text');
          const currentText = statusText.textContent.trim().toLowerCase();

          if (currentText === 'checking...') {
              updateUserStatus(userId, 'offline');
          }
      }
  }

  function updateUserStatusDisplay(userId, status) {
      const statusElement = document.getElementById('userStatus');
      if (statusElement && statusElement.getAttribute('data-user-id') === userId) {
          const statusText = statusElement.querySelector('.status-text');
          const statusDot = statusElement.querySelector('.status-dot');

          statusElement.classList.remove('loading');

          let displayText = 'Offline';
          if (status === 'online') {
              displayText = 'Online';
          } else if (status === 'away') {
              displayText = 'Away';
          } else if (status === 'offline') {
              displayText = 'Offline';
          }

          statusText.textContent = displayText;

          statusDot.className = 'status-dot';
          if (status === 'online') {
              statusDot.classList.add('online');
          } else if (status === 'offline') {
              statusDot.classList.add('offline');
          } else if (status === 'away') {
              statusDot.classList.add('away');
          }

          console.log(`‚úÖ Updated status display for user ${userId}: ${status}`);
      }
  }

  function updateUserStatus(userId, status) {
      participantStatuses.set(userId, status);
      updateUserStatusDisplay(userId, status);
  }

  // ==================== UTILITY FUNCTIONS ====================
  function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(
          date.getFullYear(),
          date.getMonth(),
          date.getDate()
      );

      if (messageDate.getTime() === today.getTime()) {
          return date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
          });
      }

      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      if (messageDate.getTime() === yesterday.getTime()) {
          return (
              "Yesterday " +
              date.toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
              })
          );
      }

      const daysDiff = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
      if (daysDiff < 7) {
          const days = [
              "Sunday",
              "Monday",
              "Tuesday",
              "Wednesday",
              "Thursday",
              "Friday",
              "Saturday",
          ];
          return (
              days[date.getDay()] +
              " " +
              date.toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
              })
          );
      }

      return (
          date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
          }) +
          " " +
          date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
          })
      );
  }

  function updateAllMessageTimes() {
      const messageTimes = document.querySelectorAll(".message-time");
      messageTimes.forEach((timeElement) => {
          const messageElement = timeElement.closest(".message");
          const messageId = messageElement.getAttribute("data-message-id");

          const currentText = timeElement.textContent;
          if (
              currentText &&
              !currentText.includes("/") &&
              !currentText.includes("-")
          ) {
              return;
          }
      });
  }

  function handleMessageUpdated(data) {
      console.log('Message updated:', data.message_id);
      updateMessageContent(data.message_id, data.new_content, data.edited_at, data.edit_count);
  }

  function handleMessageDeleted(data) {
      console.log('Message deleted:', data.message_id);
      deleteMessageFromUI(data.message_id);
  }

  function updateMessageContent(messageId, newContent, editedAt, editCount) {
      const contentElement = document.getElementById(`content-${messageId}`);
      const timeElement = document.getElementById(`time-${messageId}`);

      if (contentElement && timeElement) {
          contentElement.innerHTML = '';

          const contentText = document.createTextNode(newContent);
          contentElement.appendChild(contentText);

          const editedSpan = document.createElement('span');
          editedSpan.className = 'status-indicator edited';
          editedSpan.textContent = 'edited';
          contentElement.appendChild(editedSpan);

          const originalTime = timeElement.textContent.replace(/‚Ä¢ edited/g, '').trim();
          timeElement.innerHTML = `${originalTime} <span style="color: #666; font-size: 0.8em;">‚Ä¢ edited</span>`;
      }
  }

  function deleteMessageFromUI(messageId) {
      const contentElement = document.getElementById(`content-${messageId}`);
      const actionsElement = document.getElementById(`actions-${messageId}`);
      const menuElement = document.getElementById(`messageMenu-${messageId}`);

      if (contentElement) {
          contentElement.innerHTML = '<em style="color: #999; font-style: italic;">This message was deleted</em>';
      }

      if (actionsElement) {
          actionsElement.remove();
      }

      if (menuElement) {
          menuElement.remove();
      }

      const readReceipt = document.getElementById(`read-receipt-${messageId}`);
      if (readReceipt) {
          readReceipt.style.display = 'none';
      }
  }

  function markMessageAsRead(messageId) {
      if (socket && socket.connected) {
          socket.emit('message_read', { message_id: messageId });
      }

      fetch('/api/mark-message-read', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              message_id: messageId
          }),
      }).catch(error => {
          console.error('Error marking message as read:', error);
      });
  }

  function updateMessageReadStatus(messageId, readerId, readAt) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement) {
          let readReceipt = messageElement.querySelector('.read-receipt');
          if (!readReceipt) {
              readReceipt = document.createElement('div');
              readReceipt.className = 'read-receipt';
              messageElement.querySelector('.message-bubble').appendChild(readReceipt);
          }

          readReceipt.innerHTML = `<i class="fas fa-check-double" style="color: #4CAF50;"></i> <span style="font-size: 0.8em; color: #666;">Seen ${formatTime(new Date(readAt))}</span>`;
          readReceipt.style.display = 'block';
      }
  }

  // ==================== MESSAGE SENDING FUNCTIONS ====================
  function initializeMessageIds() {
      const existingMessages = document.querySelectorAll("[data-message-id]");
      existingMessages.forEach((message) => {
          messageIds.add(message.getAttribute("data-message-id"));
      });
      console.log("Initialized message IDs:", messageIds.size);
  }

  function sendMessage() {
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value.trim();

      if (message) {
          console.log("Sending message:", message);
          socket.emit("send_message", {
              chat_id: chatId,
              message: message,
              type: "text",
          });

          messageInput.value = "";
          resetTyping();
          adjustTextareaHeight();

          // Add theme-specific send animation
          if (currentTheme === "romantic") {
              createSendHeartAnimation();
          }
      }
  }

  function addMessageToChat(messageData, isOptimistic = false) {
      const messagesContainer = document.getElementById("messagesContainer");

      // Check if message already exists to prevent duplicates
      const existingMessage = document.querySelector(`[data-message-id="${messageData.message_id}"]`);
      if (existingMessage && !isOptimistic) {
          console.log("‚ö†Ô∏è Message already exists, skipping:", messageData.message_id);
          return;
      }

      const messageDiv = document.createElement("div");
      const isOwnMessage = messageData.sender_id === currentUserId;

      messageDiv.className = `message-wrapper ${isOwnMessage ? "own-message" : "other-message"}`;

      const messageContent = document.createElement("div");
      messageContent.className = `message ${isOwnMessage ? "own" : "other"}`;
      messageContent.setAttribute("data-message-id", messageData.message_id);
      messageContent.setAttribute("data-sender-id", messageData.sender_id);

      let timestamp;
      if (messageData.timestamp) {
          timestamp = new Date(messageData.timestamp);
      } else {
          timestamp = new Date();
      }

      const formattedTime = formatTime(timestamp);
      const isDeleted = messageData.is_deleted || false;
      const isEdited = messageData.is_edited || false;

      // Handle file messages with preview
      let fileContent = '';
      if (messageData.type === 'file' && messageData.file_metadata) {
          const fileMeta = messageData.file_metadata;

          // Construct proper URLs
          const downloadUrl = `/api/download-file/${fileMeta.uploaded_by || messageData.sender_id}/${fileMeta.saved_filename}`;
          const previewUrl = downloadUrl;

          // Check if it's an image
          const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
          const fileExt = fileMeta.original_filename ? fileMeta.original_filename.split('.').pop().toLowerCase() : '';
          const isImage = imageExtensions.includes(fileExt);

          if (isImage) {
              fileContent = `
            <div class="file-message" data-file-id="${messageData.message_id}" data-file-type="image">
              <div class="file-preview" onclick="previewFile('${messageData.message_id}')">
                <img src="${previewUrl}"
                     alt="${fileMeta.original_filename}"
                     class="file-thumbnail image"
                     style="max-width: 300px; max-height: 200px; border-radius: 8px; object-fit: cover;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="file-fallback" style="display: none; width: 300px; height: 200px; background: #f8f9fa; border-radius: 8px; align-items: center; justify-content: center; flex-direction: column;">
                  <i class="fas fa-image" style="font-size: 48px; color: #666; margin-bottom: 8px;"></i>
                  <span style="color: #666; font-size: 14px;">Image preview not available</span>
                </div>
              </div>
              <div class="file-info">
                <div class="file-name">${fileMeta.original_filename}</div>
                <div class="file-size">${(fileMeta.file_size / 1024 / 1024).toFixed(2)} MB</div>
                <div class="file-actions">
                  <button class="btn-icon" onclick="downloadFileFromMessage('${messageData.message_id}')" title="Download">
                    <i class="fas fa-download"></i> Download
                  </button>
                  <button class="btn-icon" onclick="forwardFile('${messageData.message_id}')" title="Forward">
                    <i class="fas fa-share"></i> Forward
                  </button>
                  <button class="btn-icon" onclick="previewFile('${messageData.message_id}')" title="Preview">
                    <i class="fas fa-eye"></i> Preview
                  </button>
                </div>
              </div>
            </div>
          `;
          } else {
              // Handle non-image files
              let icon = 'üìé';
              let fileType = 'other';

              if (isImage) {
                  icon = 'üñºÔ∏è';
                  fileType = 'image';
              } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv'].includes(fileExt)) {
                  icon = 'üé•';
                  fileType = 'video';
              } else if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'].includes(fileExt)) {
                  icon = 'üéµ';
                  fileType = 'audio';
              } else if (fileExt === 'pdf') {
                  icon = 'üìÑ';
                  fileType = 'document';
              } else if (['doc', 'docx'].includes(fileExt)) {
                  icon = 'üìù';
                  fileType = 'document';
              } else if (['xls', 'xlsx'].includes(fileExt)) {
                  icon = 'üìä';
                  fileType = 'document';
              } else if (['ppt', 'pptx'].includes(fileExt)) {
                  icon = 'üìΩÔ∏è';
                  fileType = 'document';
              } else if (fileExt === 'txt') {
                  icon = 'üìÑ';
                  fileType = 'document';
              }

              fileContent = `
            <div class="file-message" data-file-id="${messageData.message_id}" data-file-type="${fileType}">
              <div class="file-info">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <span style="font-size: 32px;">${icon}</span>
                  <div style="flex: 1;">
                    <div class="file-name">${fileMeta.original_filename}</div>
                    <div class="file-size">${(fileMeta.file_size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ ${fileExt.toUpperCase()}</div>
                  </div>
                </div>
                <div class="file-actions">
                  <button class="btn-icon" onclick="downloadFileFromMessage('${messageData.message_id}')" title="Download">
                    <i class="fas fa-download"></i> Download
                  </button>
                  <button class="btn-icon" onclick="forwardFile('${messageData.message_id}')" title="Forward">
                    <i class="fas fa-share"></i> Forward
                  </button>
                  ${isImage ? `<button class="btn-icon" onclick="previewFile('${messageData.message_id}')" title="Preview">
                    <i class="fas fa-eye"></i> Preview
                  </button>` : ''}
                </div>
              </div>
            </div>
          `;
          }
      }

      messageContent.innerHTML = `
        <div class="message-bubble">
          ${
              !isOwnMessage
                  ? `<div class="message-sender" id="sender-${messageData.sender_id}">${messageData.sender_username}</div>`
                  : ""
          }
          <div class="message-content" id="content-${messageData.message_id}">
            ${isDeleted ? '<em style="color: #999; font-style: italic;">This message was deleted</em>' : ''}
            ${!isDeleted && messageData.type === 'text' ? messageData.content : ''}
            ${isEdited && !isDeleted && messageData.type === 'text' ? '<span class="status-indicator edited">edited</span>' : ''}
          </div>
          ${!isDeleted && messageData.type === 'file' ? fileContent : ''}
          <div class="message-time" id="time-${messageData.message_id}">${formattedTime}</div>
          ${isOwnMessage && !isDeleted ? '<div class="read-receipt" id="read-receipt-' + messageData.message_id + '" style="display: none;"></div>' : ''}
        </div>
        ${isOwnMessage && !isDeleted ? `
          <div class="message-actions" id="actions-${messageData.message_id}">
            <button class="message-action-btn edit"
                    onclick="editMessage('${messageData.message_id}')"
                    title="Edit message">
              <i class="fas fa-edit"></i>
            </button>
            <button class="message-action-btn history"
                    onclick="showMessageHistory('${messageData.message_id}')"
                    title="View history">
              <i class="fas fa-history"></i>
            </button>
            <button class="message-action-btn delete"
                    onclick="showDeleteOptions('${messageData.message_id}')"
                    title="Delete message">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        ` : ''}
      `;

      messageDiv.appendChild(messageContent);

      if (isOwnMessage && !isDeleted) {
          const menuDiv = document.createElement('div');
          menuDiv.className = 'message-menu';
          menuDiv.id = `messageMenu-${messageData.message_id}`;
          menuDiv.innerHTML = `
          <div class="menu-content">
            <button class="menu-item edit" onclick="editMessage('${messageData.message_id}')">
              <i class="fas fa-edit"></i> Edit Message
            </button>
            <button class="menu-item history" onclick="showMessageHistory('${messageData.message_id}')">
              <i class="fas fa-history"></i> View History
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item delete" onclick="showDeleteOptions('${messageData.message_id}')">
              <i class="fas fa-trash"></i> Delete Message
            </button>
          </div>
        `;
          messageDiv.appendChild(menuDiv);
      }

      messagesContainer.appendChild(messageDiv);

      const theme = themes[currentTheme];
      if (theme) {
          updateNewMessageBubble(messageContent, theme);
      }

      // Add theme-specific animation for new messages
      if (isOwnMessage && !isOptimistic) {
          animateMessageSend(messageContent, currentTheme);
      }

      console.log("Added message to chat:", messageData.message_id, "at", formattedTime);
  }

  function handleKeyDown(event) {
      if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
      }
  }

  function handleInput() {
      adjustTextareaHeight();

      if (!isTyping) {
          isTyping = true;
          socket.emit("typing", {
              chat_id: chatId,
              is_typing: true,
          });
      }

      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
          isTyping = false;
          socket.emit("typing", {
              chat_id: chatId,
              is_typing: false,
          });
      }, 1000);
  }

  function resetTyping() {
      isTyping = false;
      socket.emit("typing", {
          chat_id: chatId,
          is_typing: false,
      });
  }

  function showTypingIndicator(data) {
      const indicator = document.getElementById("typingIndicator");
      const typingText = document.getElementById("typingText");

      if (data.is_typing) {
          typingText.textContent = data.username;
          indicator.style.display = "block";
          animateTypingIndicator();
      } else {
          indicator.style.display = "none";
          stopTypingAnimation();
      }
  }

  function animateTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
          indicator.style.animation = 'typingPulse 1.5s infinite';
      }
  }

  function stopTypingAnimation() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
          indicator.style.animation = 'none';
      }
  }

  function adjustTextareaHeight() {
      const textarea = document.getElementById("messageInput");
      textarea.style.height = "auto";
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
  }

  function scrollToBottom() {
      const container = document.getElementById("messagesContainer");
      container.scrollTop = container.scrollHeight;
  }

  // ==================== NOTIFICATION FUNCTION ====================
  function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      `;

      if (type === "success") {
          notification.style.background = "var(--success)";
      } else if (type === "error") {
          notification.style.background = "var(--error)";
      } else {
          notification.style.background = "var(--primary-blue)";
      }

      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
          notification.style.transform = "translateX(100%)";
          notification.style.opacity = "0";
          setTimeout(() => {
              if (document.body.contains(notification)) {
                  document.body.removeChild(notification);
              }
          }, 300);
      }, 3000);
  }

  // ==================== FILE PREVIEW EVENT LISTENERS ====================
  function initializeFilePreviewListeners() {
      const messagesContainer = document.getElementById('messagesContainer');

      if (!messagesContainer) {
          console.error('Messages container not found');
          return;
      }

      messagesContainer.addEventListener('click', function(e) {
          const filePreview = e.target.closest('.file-preview');
          if (filePreview) {
              const fileMessage = filePreview.closest('.file-message');
              if (fileMessage) {
                  const fileId = fileMessage.getAttribute('data-file-id');
                  if (fileId) {
                      console.log('File preview clicked:', fileId);
                      previewFile(fileId);
                      e.preventDefault();
                      e.stopPropagation();
                  }
              }
          }

          const previewBtn = e.target.closest('.btn-icon[title="Preview"]');
          if (previewBtn) {
              const fileMessage = previewBtn.closest('.file-message');
              if (fileMessage) {
                  const fileId = fileMessage.getAttribute('data-file-id');
                  if (fileId) {
                      console.log('Preview button clicked:', fileId);
                      previewFile(fileId);
                      e.preventDefault();
                      e.stopPropagation();
                  }
              }
          }
      });

      let lastTap = 0;
      messagesContainer.addEventListener('touchend', function(e) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;

          if (tapLength < 500 && tapLength > 0) {
              const filePreview = e.target.closest('.file-preview');
              if (filePreview) {
                  const fileMessage = filePreview.closest('.file-message');
                  if (fileMessage) {
                      const fileId = fileMessage.getAttribute('data-file-id');
                      if (fileId) {
                          console.log('File double-tapped on mobile:', fileId);
                          previewFile(fileId);
                          e.preventDefault();
                      }
                  }
              }
          }

          lastTap = currentTime;
      });

      console.log('‚úÖ File preview listeners initialized');
  }

  // ==================== CLEANUP FUNCTIONS ====================
  function cleanupSocket() {
      if (socket) {
          socket.emit("leave_chat", { chat_id: chatId });
          socket.disconnect();
          socket = null;
      }
  }

  // ==================== INITIALIZATION ====================
  document.addEventListener("DOMContentLoaded", function () {
      console.log("üöÄ Initializing chat...");

      try {
          initializeMessageIds();
          initializeSocket();
          initializeParticipantStatuses();
          setupMessageActions();
          initializeFileUpload();
          initializeEmojiReactions();
          initializeEmojiPickerButton();
          initializeFilePreviewListeners();
          loadLocalMessages(); // Load persisted messages
          scrollToBottom();
          adjustTextareaHeight();
          loadThemePreference();
          updateAllMessageTimes();

          const messageInput = document.getElementById("messageInput");
          if (messageInput) messageInput.focus();

          const themeMenuButton = document.getElementById("themeMenuButton");
          if (themeMenuButton) {
              themeMenuButton.addEventListener("click", function (e) {
                  e.stopPropagation();
                  toggleThemeMenu();
              });
          }

          const chatInfo = document.getElementById("chatInfo");
          if (chatInfo) {
              chatInfo.addEventListener("click", function(e) {
                  console.log('Chat header clicked');

                  const excludedElements = e.target.closest('.back-button') ||
                      e.target.closest('.chat-actions') ||
                      e.target.closest('.dropdown') ||
                      e.target.closest('.btn') ||
                      e.target.closest('.theme-option');

                  if (!excludedElements) {
                      openUserProfile(e);
                  }
              });

              chatInfo.addEventListener("mouseenter", function() {
                  this.style.opacity = "0.8";
                  this.style.transition = "opacity 0.2s ease";
              });

              chatInfo.addEventListener("mouseleave", function() {
                  this.style.opacity = "1";
              });
          }

          // Global click handlers to close menus
          document.addEventListener('click', function(event) {
              if (!event.target.closest('.message-menu') &&
                  !event.target.closest('.message-actions') &&
                  !event.target.closest('.message-action-btn')) {
                  closeMessageMenu();
              }

              if (event.target.classList.contains('custom-modal')) {
                  closeDeleteModal();
                  closeHistoryModal();
                  closeFilePreview();
                  closeForwardModal();
                  closeEmojiPicker();
              }
          });

          document.addEventListener('keydown', function(event) {
              if (event.key === 'Escape') {
                  closeMessageMenu();
                  closeHistoryModal();
                  closeDeleteModal();
                  if (editingMessageId) {
                      cancelEdit(editingMessageId);
                  }
              }
          });

          const chatContainer = document.getElementById("chatContainer");
          if (chatContainer && chatContainer.classList.contains("theme-romantic")) {
              createFloatingHearts();
          }

          // Add ripple animation CSS
          const style = document.createElement('style');
          style.textContent = `
              @keyframes rippleExpand {
                  0% {
                      transform: scale(0.1);
                      opacity: 1;
                  }
                  100% {
                      transform: scale(2);
                      opacity: 0;
                  }
              }
          `;
          document.head.appendChild(style);

          console.log("‚úÖ Chat initialization complete");
      } catch (error) {
          console.error("‚ùå Error during initialization:", error);
      }
  });

  document.addEventListener("click", function (event) {
      const themeMenu = document.getElementById("themeMenu");
      const themeButton = document.getElementById("themeMenuButton");
      if (themeMenu && themeButton && !themeMenu.contains(event.target) && !themeButton.contains(event.target)) {
          closeThemeMenu();
      }
  });

  window.addEventListener("beforeunload", cleanupSocket);
  window.addEventListener("pagehide", cleanupSocket);
</script>

<style>
  /* Custom Modal Styles */
  .custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    backdrop-filter: blur(5px);
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 0;
    min-width: 400px;
    max-width: 90%;
    max-height: 80%;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translate(-50%, -60%);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e0e0e0;
  }

  .modal-header h3 {
    margin: 0;
    color: #1f2937;
    font-size: 18px;
    font-weight: 600;
  }

  .close-modal {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #6b7280;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .close-modal:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .modal-body {
    padding: 24px;
  }

  .modal-body p {
    margin: 0 0 20px 0;
    color: #6b7280;
    font-size: 14px;
  }

  .delete-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .delete-option {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
  }

  .delete-option:hover {
    border-color: #3b82f6;
    background: #f8fafc;
    transform: translateY(-2px);
  }

  .option-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    color: #6b7280;
    font-size: 16px;
  }

  .option-content {
    flex: 1;
  }

  .option-content strong {
    display: block;
    color: #1f2937;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .option-content span {
    display: block;
    color: #6b7280;
    font-size: 12px;
    line-height: 1.4;
  }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
  }

  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }

  .btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
  }

  /* File Message Styles */
  .file-message {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 12px;
    margin: 8px 0;
    background: white;
    max-width: 400px;
  }

  .file-preview {
    cursor: pointer;
    margin-bottom: 8px;
  }

  .file-thumbnail {
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }

  .file-thumbnail.image img {
    width: 100%;
    height: auto;
    max-height: 200px;
    object-fit: cover;
  }

  .file-thumbnail.video {
    position: relative;
    background: #000;
  }

  .file-thumbnail.video img {
    width: 100%;
    height: auto;
    max-height: 150px;
    object-fit: cover;
    opacity: 0.7;
  }

  .file-thumbnail.video i {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    color: white;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  .file-thumbnail.audio,
  .file-thumbnail.document {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    color: #6c757d;
  }

  .file-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .file-name {
    font-weight: 600;
    color: #333;
    word-break: break-word;
  }

  .file-size {
    font-size: 12px;
    color: #666;
  }

  .file-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }

  .btn-icon {
    background: none;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
    color: #666;
    transition: all 0.2s ease;
  }

  .btn-icon:hover {
    background: #f8f9fa;
    border-color: #007bff;
    color: #007bff;
  }

  /* Forward Modal Styles */
  .forward-file-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .file-info-preview {
    display: flex;
    align-items: center;
  }

  .friends-checkbox-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }

  .friend-checkbox-item {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
  }

  .friend-checkbox-item:last-child {
    border-bottom: none;
  }

  .friend-checkbox-item label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    margin: 0;
  }

  .friend-checkbox {
    margin: 0;
  }

  .friend-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  .friend-info {
    flex: 1;
  }

  .friend-name {
    font-weight: 600;
    color: #333;
  }

  .friend-status {
    font-size: 12px;
    color: #666;
  }

  /* Emoji Picker Styles */
  .emoji-picker {
    width: 300px;
    max-width: 90vw;
  }

  .emoji-categories {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    padding: 0 16px;
  }

  .emoji-category {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 8px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .emoji-category.active {
    border-bottom-color: #007bff;
    color: #007bff;
  }

  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    padding: 16px;
    max-height: 200px;
    overflow-y: auto;
  }

  .emoji-option {
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    transition: all 0.2s ease;
    text-align: center;
  }

  .emoji-option:hover {
    background: #f8f9fa;
    transform: scale(1.2);
  }

  /* Reaction Styles */
  .message-reactions {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }

  .reaction {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .reaction:hover {
    background: #f8f9fa;
    border-color: #007bff;
    transform: scale(1.05);
  }

  .reaction-count {
    font-size: 10px;
    color: #666;
  }

  /* Drag and Drop Styles */
  .drag-over {
    background: rgba(0, 123, 255, 0.1) !important;
    border: 2px dashed #007bff !important;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
  }

  .form-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
  }

  /* Enhanced Message Actions Styles */
  .message-actions {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    gap: 4px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }

  .message:hover .message-actions {
    opacity: 1;
    transform: translateY(-50%) scale(1.05);
  }

  .message-action-btn {
    background: none;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
    font-size: 14px;
  }

  .message-action-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
    color: #333;
  }

  .message-action-btn.edit:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .message-action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .message-action-btn.history:hover {
    background: rgba(139, 69, 19, 0.1);
    color: #8b4513;
  }

  /* Enhanced Message Menu */
  .message-menu {
    display: none;
    position: absolute;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid #e0e0e0;
    min-width: 200px;
    z-index: 1000;
    animation: slideDown 0.2s ease;
    backdrop-filter: blur(10px);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .menu-content {
    padding: 8px 0;
  }

  .menu-item {
    width: 100%;
    border: none;
    background: none;
    padding: 12px 20px;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    transition: all 0.2s ease;
    color: #333;
  }

  .menu-item:hover {
    background: #f8f9fa;
    transform: translateX(5px);
  }

  .menu-item i {
    width: 16px;
    text-align: center;
  }

  .menu-item.edit {
    color: #3b82f6;
  }

  .menu-item.delete {
    color: #ef4444;
  }

  .menu-item.history {
    color: #8b4513;
  }

  .menu-divider {
    height: 1px;
    background: #f0f0f0;
    margin: 4px 0;
  }

  /* Enhanced Edit Message Interface */
  .edit-message-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
  }

  .edit-message-input {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
    transition: border-color 0.2s ease;
  }

  .edit-message-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .edit-message-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    align-items: center;
  }

  .edit-character-count {
    font-size: 12px;
    color: #6b7280;
    margin-right: auto;
  }

  .edit-character-count.warning {
    color: #f59e0b;
  }

  .edit-character-count.error {
    color: #ef4444;
  }

  .btn-sm {
    padding: 8px 16px;
    font-size: 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .btn-primary {
    background: #3b82f6;
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }

  .btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
  }

  /* Message History Modal */
  .history-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    backdrop-filter: blur(5px);
  }

  .history-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 24px;
    min-width: 400px;
    max-width: 90%;
    max-height: 80%;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e0e0e0;
  }

  .history-header h3 {
    margin: 0;
    color: #1f2937;
    font-size: 18px;
  }

  .close-history {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #6b7280;
    padding: 4px;
    border-radius: 4px;
  }

  .close-history:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .history-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-left: 4px solid #3b82f6;
  }

  .history-item.original {
    border-left-color: #10b981;
  }

  .history-item.edit {
    border-left-color: #f59e0b;
  }

  .history-item.current {
    border-left-color: #3b82f6;
    background: #eff6ff;
  }

  .history-content-text {
    margin: 8px 0;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .history-meta {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
    display: flex;
    justify-content: space-between;
  }

  /* Enhanced Read Receipts */
  .read-receipt {
    font-size: 11px;
    color: #6b7280;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .read-receipt:hover {
    opacity: 1;
  }

  .read-receipt i {
    color: #3b82f6;
  }

  .read-receipt.seen i {
    color: #10b981;
  }

  /* Message Status Indicators */
  .message-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: #6b7280;
    margin-top: 4px;
  }

  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
  }

  .status-indicator.edited {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    margin-left: 8px;
  }

  .status-indicator.deleted {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  /* Enhanced Message Actions for Mobile */
  @media (max-width: 768px) {
    .message-actions {
      opacity: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #e0e0e0;
    }

    .message-menu {
      min-width: 180px;
      left: 50% !important;
      transform: translateX(-50%);
    }

    .menu-item {
      padding: 16px 20px;
      font-size: 16px;
    }

    .message-action-btn {
      width: 44px;
      height: 44px;
      font-size: 18px;
    }

    .modal-content {
      min-width: 90%;
      margin: 20px;
    }

    .delete-option {
      padding: 20px;
    }
  }

  /* Touch-friendly styles */
  .message-bubble {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    cursor: default;
  }

  /* Allow text selection only for message content */
  .message-content {
    -webkit-touch-callout: text;
    -webkit-user-select: text;
    -khtml-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
    cursor: text;
  }

  /* Enhanced message menu for better mobile visibility */
  .message-menu {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  }

  /* Long press visual feedback */
  .message.own:active {
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  /* Prevent text selection during long press */
  .message.own {
    -webkit-tap-highlight-color: transparent;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .history-content {
      min-width: 90%;
      margin: 20px;
      padding: 16px;
    }

    .edit-message-container {
      padding: 12px;
    }

    .menu-item {
      padding: 16px 20px;
      font-size: 16px;
    }

    .message-action-btn {
      width: 36px;
      height: 36px;
      font-size: 16px;
    }
  }

  /* Animation for message actions */
  @keyframes pulse-gentle {
    0%,
    100% {
      transform: translateY(-50%) scale(1);
    }
    50% {
      transform: translateY(-50%) scale(1.05);
    }
  }

  .message-actions.pulse {
    animation: pulse-gentle 2s ease-in-out infinite;
  }

  /* Enhanced chat header hover effects */
  .chat-info {
    transition: all 0.2s ease;
    border-radius: 8px;
    padding: 4px 8px;
    margin: -4px -8px;
    cursor: pointer;
  }

  .chat-info:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }

  .chat-info:active {
    background-color: rgba(0, 0, 0, 0.1);
    transform: scale(0.98);
  }

  .chat-details h2 {
    transition: color 0.2s ease;
  }

  .chat-info:hover .chat-details h2 {
    color: #3b82f6;
  }

  /* Status indicator styles */
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .status-dot.online {
    background-color: #22c55e;
    box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
  }

  .status-dot.offline {
    background-color: #6b7280;
  }

  .status-dot.away {
    background-color: #f59e0b;
    box-shadow: 0 0 6px rgba(245, 158, 11, 0.5);
  }

  .status-text {
    font-size: 0.875rem;
    color: #6b7280;
    transition: color 0.3s ease;
  }

  /* Pulse animation for online status */
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .status-dot.online {
    animation: pulse 2s infinite;
  }

  /* Loading state */
  .status-indicator.loading .status-dot {
    background-color: #9ca3af;
    animation: pulse 1.5s infinite;
  }

  .status-indicator.loading .status-text {
    color: #9ca3af;
  }

  /* Responsive Design for File Features */
  @media (max-width: 768px) {
    .file-message {
      max-width: 100%;
    }

    .emoji-picker {
      width: 280px;
    }

    .emoji-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  /* Emoji Picker Button Styles */
  .emoji-picker-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: #6b7280;
    font-size: 18px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .emoji-picker-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #3b82f6;
    transform: scale(1.1);
  }

  .emoji-picker-btn:active {
    transform: scale(0.95);
  }

  /* File Upload Button Styles */
  .file-upload-btn {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    color: #6b7280;
    font-size: 16px;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .file-upload-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #3b82f6;
    transform: scale(1.1);
  }

  .file-upload-btn:active {
    transform: scale(0.95);
  }

  /* Message Input Container Enhancements */
  .message-input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 24px;
    margin: 0 16px 16px;
    border: 1px solid #e0e0e0;
    transition: all 0.2s ease;
  }

  .message-input-wrapper:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  /* Send Button Styles */
  .send-button {
    background: #3b82f6;
    border: none;
    padding: 10px 14px;
    cursor: pointer;
    color: white;
    font-size: 16px;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
  }

  .send-button:hover {
    background: #2563eb;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .send-button:active {
    transform: scale(0.95);
  }

  .send-button:disabled {
    background: #6b7280;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Message Input Styles */
  .message-input {
    flex: 1;
    border: none;
    outline: none;
    resize: none;
    font-size: 14px;
    line-height: 1.4;
    max-height: 120px;
    min-height: 20px;
    padding: 8px 0;
    background: transparent;
    color: #1f2937;
    font-family: inherit;
  }

  .message-input::placeholder {
    color: #6b7280;
  }

  /* Button Group Container */
  .input-buttons {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Enhanced File Input Styles */
  #fileInput {
    display: none;
  }

  /* Upload Progress Indicator */
  .upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .upload-progress-bar {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
    width: 0%;
  }

  /* File Upload Status */
  .upload-status {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 300px;
  }

  .upload-status.success {
    border-left: 4px solid #10b981;
  }

  .upload-status.error {
    border-left: 4px solid #ef4444;
  }

  .upload-status.info {
    border-left: 4px solid #3b82f6;
  }

  /* Recent Emojis Section */
  .recent-emojis {
    border-bottom: 1px solid #e0e0e0;
    padding: 12px 16px;
  }

  .recent-emojis h4 {
    margin: 0 0 8px 0;
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .message-input-wrapper {
      margin: 0 12px 12px;
      padding: 10px 14px;
      border-radius: 20px;
    }

    .emoji-picker-btn,
    .file-upload-btn {
      padding: 10px;
      font-size: 18px;
      min-width: 44px;
      min-height: 44px;
    }

    .send-button {
      padding: 12px;
      font-size: 18px;
      min-width: 48px;
      min-height: 48px;
    }

    .emoji-picker .modal-content {
      width: 280px;
    }

    .emoji-grid {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* Touch Device Optimizations */
  @media (hover: none) and (pointer: coarse) {
    .emoji-picker-btn:hover,
    .file-upload-btn:hover,
    .send-button:hover {
      transform: none;
      background: none;
    }

    .emoji-picker-btn:active,
    .file-upload-btn:active,
    .send-button:active {
      background: rgba(0, 0, 0, 0.1);
      transform: scale(0.95);
    }
  }

  /* Animation for button interactions */
  @keyframes buttonBounce {
    0%,
    20%,
    60%,
    100% {
      transform: scale(1);
    }
    40% {
      transform: scale(1.1);
    }
    80% {
      transform: scale(1.05);
    }
  }

  .emoji-picker-btn:active,
  .file-upload-btn:active,
  .send-button:active {
    animation: buttonBounce 0.3s ease;
  }

  /* Loading state for file upload */
  .file-upload-btn.uploading {
    position: relative;
    color: transparent;
  }

  .file-upload-btn.uploading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Message Text Colors - FIX FOR WHITE TEXT ISSUE */
  .message-content {
    color: #1f2937 !important;
  }

  .message.own .message-content {
    color: white !important;
  }

  .message-sender {
    color: #3b82f6 !important;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .message-time {
    color: #6b7280 !important;
  }

  /* Ensure proper text colors in themes */
  .message.other .message-bubble {
    background: #f8f9fa;
    color: #1f2937;
  }

  .message.own .message-bubble {
    background: #3b82f6;
    color: white;
  }

  /* Fix for message actions visibility */
  .message-actions {
    opacity: 0;
    transition: all 0.3s ease;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }

  .message:hover .message-actions {
    opacity: 1;
    transform: translateY(-50%) scale(1.05);
  }

  /* Ensure message wrapper has relative positioning */
  .message-wrapper {
    position: relative;
  }

  /* Fix for mobile touch */
  @media (max-width: 768px) {
    .message-actions {
      opacity: 0.9; /* Always visible on mobile when active */
      background: rgba(255, 255, 255, 0.98);
    }

    .message:active .message-actions {
      opacity: 1;
    }
  }

  .emoji-picker .modal-content {
    width: 75%;
    max-width: 500px;
    height: 400px;
    display: flex;
    flex-direction: column;
  }

  .emoji-picker .modal-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 0;
  }

  .emoji-categories {
    flex-shrink: 0;
  }

  .emoji-grid {
    flex: 1;
    max-height: 300px;
    overflow-y: auto;
  }

  /* Emoji Picker Styles */
  .emoji-picker {
    width: 75%;
    max-width: 500px;
    height: 400px;
  }

  .emoji-category.active {
    border-bottom-color: #3b82f6 !important;
    color: #3b82f6;
  }

  .emoji-option {
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 40px;
  }

  .emoji-option:hover {
    background: #f3f4f6;
    transform: scale(1.1);
  }

  .emoji-option:active {
    transform: scale(0.95);
  }

  /* Ensure emojis display correctly */
  .emoji-grid {
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji",
      "Android Emoji", "EmojiSymbols", "EmojiOne Mozilla", "Twemoji Mozilla",
      "Segoe UI Symbol", "Noto Color Emoji Compat", "emoji", "symbols",
      "symbols-alt";
  }

  /* File Upload Progress */
  .upload-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    z-index: 10001;
  }

  .upload-progress-bar {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
    width: 0%;
  }

  /* Fix for modal display */
  .custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    backdrop-filter: blur(5px);
  }

  .custom-modal[style*="display: block"] {
    display: flex !important;
    align-items: center;
    justify-content: center;
  }

  .modal-content.large {
    width: 80%;
    max-width: 800px;
    height: 80%;
    display: flex;
    flex-direction: column;
  }

  .modal-content .modal-body {
    flex: 1;
    overflow: auto;
  }

  .chat-avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
  }
</style>
{% endblock %}
