{% extends "base.html" %} {% block title %}Edit Profile - HangSpace{% endblock
%} {% block content %}
<div class="profile-container">
  <!-- Back Button -->
  <div style="margin-bottom: 1rem">
    <a href="{{ url_for('my_profile') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Profile
    </a>
  </div>

  <!-- Edit Profile Form -->
  <div class="card">
    <div class="card-header">
      <h2 style="color: var(--text-dark); margin: 0">
        <i class="fas fa-edit"></i> Edit Profile
      </h2>
    </div>
    <div class="card-body">
      <!-- Profile Picture Section -->
      <div
        class="avatar-section"
        style="text-align: center; margin-bottom: 2rem"
      >
        <div class="profile-pic-container">
          {% if user.avatar_url %}
          <img
            src="{{ user.avatar_url }}"
            alt="Profile Picture"
            class="profile-pic-large"
            id="profilePicPreview"
            onerror="this.style.display='none'; document.getElementById('defaultAvatar').style.display='flex';"
          />
          {% endif %}
          <div
            id="defaultAvatar"
            class="profile-avatar-large"
            style="{% if user.avatar_url %}display: none;{% endif %}"
          >
            {{ user.display_name[0]|upper if user.display_name else
            user.username[0]|upper }}
          </div>
        </div>

        <div style="margin-top: 1rem">
          <!-- Upload Profile Picture Form -->
          <form
            id="uploadProfilePicForm"
            enctype="multipart/form-data"
            style="display: inline-block"
          >
            <input
              type="file"
              id="profilePicInput"
              name="profile_pic"
              accept="image/*"
              style="display: none"
              onchange="handleProfilePicUpload()"
            />
            <button
              type="button"
              class="btn btn-primary"
              onclick="document.getElementById('profilePicInput').click()"
            >
              <i class="fas fa-camera"></i> Change Photo
            </button>
          </form>

          {% if user.avatar_url %}
          <button
            type="button"
            class="btn btn-secondary"
            onclick="removeProfilePic()"
            style="margin-left: 0.5rem"
          >
            <i class="fas fa-trash"></i> Remove
          </button>
          {% endif %}
        </div>

        <p
          style="
            color: var(--text-light);
            margin-top: 0.5rem;
            font-size: 0.8rem;
          "
        >
          Supported formats: JPG, PNG, GIF • Max size: 5MB
        </p>

        <!-- Upload Progress -->
        <div id="uploadProgress" style="display: none; margin-top: 0.5rem">
          <div
            style="
              background: var(--border-light);
              border-radius: 10px;
              height: 6px;
              overflow: hidden;
            "
          >
            <div
              id="progressBar"
              style="
                background: var(--primary-blue);
                height: 100%;
                width: 0%;
                transition: width 0.3s ease;
              "
            ></div>
          </div>
          <div
            id="progressText"
            style="
              font-size: 0.8rem;
              color: var(--text-light);
              margin-top: 0.25rem;
            "
          >
            Uploading...
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <form id="editProfileForm">
        <!-- Display Name -->
        <div class="form-group">
          <label for="displayName" class="form-label">
            <i class="fas fa-user"></i> Display Name
          </label>
          <input
            type="text"
            id="displayName"
            name="display_name"
            class="form-input"
            value="{{ user.display_name if user.display_name else '' }}"
            placeholder="Enter your display name"
            maxlength="30"
          />
          <div class="form-help">This is how other users will see you</div>
        </div>

        <!-- Username -->
        <div class="form-group">
          <label for="username" class="form-label">
            <i class="fas fa-at"></i> Username
          </label>
          <div style="display: flex; gap: 0.5rem">
            <input
              type="text"
              id="username"
              name="username"
              class="form-input"
              value="{{ user.username }}"
              placeholder="Choose a username"
              maxlength="20"
              pattern="[a-zA-Z0-9_]+"
              title="Only letters, numbers, and underscores allowed"
            />
            <button
              type="button"
              class="btn btn-secondary"
              onclick="checkUsernameAvailability()"
            >
              Check
            </button>
          </div>
          <div class="form-help">
            Only letters, numbers, and underscores allowed. 3-20 characters.
          </div>
          <div
            id="usernameAvailability"
            style="display: none; margin-top: 0.5rem"
          ></div>
        </div>

        <!-- Status Message -->
        <div class="form-group">
          <label for="status" class="form-label">
            <i class="fas fa-comment"></i> Status Message
          </label>
          <textarea
            id="status"
            name="status"
            class="form-input"
            placeholder="What's on your mind?"
            rows="3"
            maxlength="100"
          >
{{ user.status if user.status else '' }}</textarea
          >
          <div class="form-help">
            Let people know what you're up to (max 100 characters)
          </div>
          <div class="char-counter">
            <span id="charCount">0</span>/100 characters
          </div>
        </div>

        <!-- Form Actions -->
        <div
          class="form-actions"
          style="display: flex; gap: 1rem; margin-top: 2rem"
        >
          <button type="submit" class="btn btn-primary" style="flex: 1">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="window.history.back()"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card" style="border-color: var(--error); margin-top: 2rem">
    <div class="card-header" style="border-bottom-color: var(--error)">
      <h3 style="color: var(--error); margin: 0">
        <i class="fas fa-exclamation-triangle"></i> Danger Zone
      </h3>
    </div>
    <div class="card-body">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <div>
          <h4 style="color: var(--text-dark); margin-bottom: 0.5rem">
            Delete Profile
          </h4>
          <p style="color: var(--text-light); margin: 0">
            Permanently delete your profile and all associated data. This action
            cannot be undone.
          </p>
        </div>
        <button class="btn btn-danger" onclick="showDeleteConfirmation()">
          <i class="fas fa-trash"></i> Delete Profile
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none">
  <div class="modal-content" style="max-width: 500px">
    <div class="modal-header">
      <h3 style="color: var(--error); margin: 0">
        <i class="fas fa-exclamation-triangle"></i> Delete Profile
      </h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 1rem">
        <strong>This action cannot be undone!</strong>
      </p>
      <p style="color: var(--text-light); margin-bottom: 1.5rem">
        This will permanently delete your profile "<strong
          >{{ user.display_name if user.display_name else user.username
          }}</strong
        >" and remove all your messages, friends, and chat history.
      </p>
      <div class="form-group">
        <label for="confirmUsername" class="form-label">
          Type your username to confirm:
        </label>
        <input
          type="text"
          id="confirmUsername"
          class="form-input"
          placeholder="{{ user.username }}"
          oninput="checkDeleteConfirmation()"
        />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideDeleteModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button
        id="deleteButton"
        class="btn btn-danger"
        disabled
        onclick="deleteProfile()"
      >
        <i class="fas fa-trash"></i> Delete Profile
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_css %}
<style>
  .profile-pic-container {
    position: relative;
    display: inline-block;
  }

  .profile-pic-large {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-blue);
    box-shadow: var(--shadow-lg);
  }

  .profile-avatar-large {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-blue), #007acc);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 3rem;
    margin: 0 auto;
    box-shadow: var(--shadow-lg);
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
    font-weight: 500;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 0.5rem;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    background: var(--primary-white);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
  }

  .form-help {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  .char-counter {
    text-align: right;
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  .availability-available {
    color: var(--success);
    font-weight: 500;
  }

  .availability-taken {
    color: var(--error);
    font-weight: 500;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: var(--primary-white);
    border-radius: 1rem;
    width: 90%;
    max-width: 600px;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  .btn-danger {
    background: var(--error);
    color: white;
    border: none;
  }

  .btn-danger:hover:not(:disabled) {
    background: #dc2626;
  }

  .btn-danger:disabled {
    background: var(--text-light);
    cursor: not-allowed;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  let originalUsername = "{{ user.username }}";

  document.addEventListener("DOMContentLoaded", function () {
    initializeEditForm();
    updateCharCount();
  });

  function initializeEditForm() {
    const form = document.getElementById("editProfileForm");
    const statusInput = document.getElementById("status");

    // Update character counter
    statusInput.addEventListener("input", updateCharCount);

    // Handle form submission
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      saveProfileChanges();
    });

    // Validate username input
    const usernameInput = document.getElementById("username");
    usernameInput.addEventListener("input", function () {
      this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, "");
    });
  }

  function updateCharCount() {
    const statusInput = document.getElementById("status");
    const charCount = document.getElementById("charCount");
    charCount.textContent = statusInput.value.length;
  }

  function handleProfilePicUpload() {
    const fileInput = document.getElementById("profilePicInput");
    const file = fileInput.files[0];

    if (!file) return;

    // Validate file type
    if (!file.type.startsWith("image/")) {
      showNotification("Please select an image file", "error");
      return;
    }

    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
      showNotification("File size must be less than 5MB", "error");
      return;
    }

    // Show preview
    const reader = new FileReader();
    reader.onload = function (e) {
      const previewImg = document.getElementById("profilePicPreview");
      const defaultAvatar = document.getElementById("defaultAvatar");

      if (!previewImg) {
        // Create image element if it doesn't exist
        const container = document.querySelector(".profile-pic-container");
        const img = document.createElement("img");
        img.id = "profilePicPreview";
        img.className = "profile-pic-large";
        img.alt = "Profile Picture";
        img.src = e.target.result;
        container.insertBefore(img, defaultAvatar);
        defaultAvatar.style.display = "none";
      } else {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
        defaultAvatar.style.display = "none";
      }
    };
    reader.readAsDataURL(file);

    // Upload file
    uploadProfilePic(file);
  }

  function uploadProfilePic(file) {
    const formData = new FormData();
    formData.append("profile_pic", file);

    // Show progress
    const progressDiv = document.getElementById("uploadProgress");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    progressDiv.style.display = "block";
    progressBar.style.width = "0%";
    progressText.textContent = "Uploading...";

    fetch("/api/upload-profile-pic", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        progressDiv.style.display = "none";

        if (data.success) {
          showNotification("Profile picture updated successfully!", "success");
          // Update the avatar URL in the image src to use the server URL
          const previewImg = document.getElementById("profilePicPreview");
          if (previewImg) {
            previewImg.src = data.avatar_url + "?t=" + new Date().getTime(); // Cache bust
          }
        } else {
          showNotification(
            data.error || "Failed to upload profile picture",
            "error"
          );
          // Revert to default avatar on error
          revertToDefaultAvatar();
        }
      })
      .catch((error) => {
        console.error("Error uploading profile picture:", error);
        progressDiv.style.display = "none";
        showNotification("Error uploading profile picture", "error");
        revertToDefaultAvatar();
      });

    // Simulate progress (since we can't get real progress with fetch)
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += 5;
      progressBar.style.width = progress + "%";
      if (progress >= 90) {
        clearInterval(progressInterval);
      }
    }, 100);
  }

  function removeProfilePic() {
    if (!confirm("Are you sure you want to remove your profile picture?")) {
      return;
    }

    fetch("/api/remove-profile-pic", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Profile picture removed successfully!", "success");
          revertToDefaultAvatar();
        } else {
          showNotification(
            data.error || "Failed to remove profile picture",
            "error"
          );
        }
      })
      .catch((error) => {
        console.error("Error removing profile picture:", error);
        showNotification("Error removing profile picture", "error");
      });
  }

  function revertToDefaultAvatar() {
    const previewImg = document.getElementById("profilePicPreview");
    const defaultAvatar = document.getElementById("defaultAvatar");

    if (previewImg) {
      previewImg.style.display = "none";
    }
    defaultAvatar.style.display = "flex";
  }

  function checkUsernameAvailability() {
    const usernameInput = document.getElementById("username");
    const username = usernameInput.value.trim();
    const availabilityDiv = document.getElementById("usernameAvailability");

    if (!username) {
      showNotification("Please enter a username", "error");
      return;
    }

    if (username.length < 3) {
      availabilityDiv.innerHTML =
        '<span class="availability-taken">Username must be at least 3 characters</span>';
      availabilityDiv.style.display = "block";
      return;
    }

    if (username === originalUsername) {
      availabilityDiv.innerHTML =
        '<span class="availability-available">This is your current username</span>';
      availabilityDiv.style.display = "block";
      return;
    }

    // Show checking state
    availabilityDiv.innerHTML =
      '<span style="color: var(--text-light);">Checking availability...</span>';
    availabilityDiv.style.display = "block";

    fetch("/api/check-username", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ username: username }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.available) {
          availabilityDiv.innerHTML =
            '<span class="availability-available">✓ Username available!</span>';
        } else {
          availabilityDiv.innerHTML =
            '<span class="availability-taken">✗ Username already taken</span>';
        }
        availabilityDiv.style.display = "block";
      })
      .catch((error) => {
        console.error("Error checking username:", error);
        availabilityDiv.innerHTML =
          '<span class="availability-taken">Error checking username</span>';
        availabilityDiv.style.display = "block";
      });
  }

  async function saveProfileChanges() {
    const form = document.getElementById("editProfileForm");
    const formData = new FormData(form);
    const updates = {};

    // Collect form data
    for (let [key, value] of formData) {
      if (value.trim()) {
        updates[key] = value.trim();
      }
    }

    if (Object.keys(updates).length === 0) {
      showNotification("No changes to save", "info");
      return;
    }

    // If username changed, use separate endpoint
    if (updates.username && updates.username !== originalUsername) {
      const usernameResult = await changeUsername(updates.username);
      if (!usernameResult.success) {
        return; // Stop if username change failed
      }
      delete updates.username; // Remove from general updates
    }

    // Save other updates
    if (Object.keys(updates).length > 0) {
      await saveProfileUpdates(updates);
    }
  }

  async function changeUsername(newUsername) {
    try {
      const response = await fetch("/api/change-username", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ username: newUsername }),
      });

      const data = await response.json();

      if (data.success) {
        originalUsername = newUsername;
        showNotification("Username updated successfully!", "success");
        return { success: true };
      } else {
        showNotification(data.error || "Failed to update username", "error");
        return { success: false };
      }
    } catch (error) {
      console.error("Error changing username:", error);
      showNotification("Error updating username", "error");
      return { success: false };
    }
  }

  async function saveProfileUpdates(updates) {
    try {
      const response = await fetch("/api/update-profile", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(updates),
      });

      const data = await response.json();

      if (data.success) {
        showNotification("Profile updated successfully!", "success");
        // Reload page after a short delay to show changes
        setTimeout(() => {
          window.location.href = "/my-profile";
        }, 1000);
      } else {
        showNotification(data.error || "Failed to update profile", "error");
      }
    } catch (error) {
      console.error("Error updating profile:", error);
      showNotification("Error updating profile", "error");
    }
  }

  function showDeleteConfirmation() {
    const modal = document.getElementById("deleteModal");
    modal.style.display = "flex";
  }

  function hideDeleteModal() {
    const modal = document.getElementById("deleteModal");
    modal.style.display = "none";
  }

  function checkDeleteConfirmation() {
    const confirmInput = document.getElementById("confirmUsername");
    const deleteButton = document.getElementById("deleteButton");
    const currentUsername = "{{ user.username }}";

    deleteButton.disabled = confirmInput.value !== currentUsername;
  }

  function deleteProfile() {
    if (!confirm("Are you absolutely sure? This cannot be undone!")) {
      return;
    }

    fetch("/api/delete-profile", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Profile deleted successfully", "success");
          setTimeout(() => {
            window.location.href = "/logout";
          }, 2000);
        } else {
          showNotification(data.error || "Failed to delete profile", "error");
        }
      })
      .catch((error) => {
        console.error("Error deleting profile:", error);
        showNotification("Error deleting profile", "error");
      });

    hideDeleteModal();
  }

  function showNotification(message, type = "info") {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll(
      ".edit-profile-notification"
    );
    existingNotifications.forEach((notification) => notification.remove());

    const notification = document.createElement("div");
    notification.className = `edit-profile-notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `;

    if (type === "success") {
      notification.style.background = "var(--success)";
    } else if (type === "error") {
      notification.style.background = "var(--error)";
    } else if (type === "warning") {
      notification.style.background = "var(--warning)";
    } else {
      notification.style.background = "var(--primary-blue)";
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = "translateX(100%)";
      notification.style.opacity = "0";
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 3000);
  }

  // Close modal when clicking outside
  document
    .getElementById("deleteModal")
    ?.addEventListener("click", function (e) {
      if (e.target === this) {
        hideDeleteModal();
      }
    });
</script>
{% endblock %}
